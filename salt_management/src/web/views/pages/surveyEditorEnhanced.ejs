<% var body = ` 
<link rel="stylesheet" href="/css/survey-editor.css">

<h2>Survey Editor: ${survey.name} (v${survey.version})</h2>

<div class="card">
    <h3>Survey Configuration</h3>
    <form id="surveyForm" style="margin-bottom: 1rem;">
        <div class="form-row">
            <div class="form-group">
                <label>Survey Name</label>
                <input type="text" id="surveyName" class="form-control" value="${survey.name}" placeholder="Survey Name">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="surveyDescription" class="form-control" value="${survey.description || ''}" placeholder="Description">
            </div>
        </div>
        <button type="submit" class="btn">Update Survey Details</button>
    </form>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Questions (${questions.length})</h3>
        <div>
            <button onclick="reorderQuestions()" class="btn" style="margin-right: 0.5rem;">Save Order</button>
            <button onclick="showAddQuestion()" class="btn">Add Question</button>
        </div>
    </div>
    
    <div id="questionsList">
        ${questions.map((q, idx) => `
            <div class="question-item" draggable="true" data-question-id="${q.id}" data-question-index="${q.question_index}">
                <div class="question-header">
                    <div style="flex: 1;">
                        <span class="drag-handle">â‰¡</span>
                        <span class="question-number">Q${q.question_index + 1}</span>
                        <strong>${q.short_name}</strong>
                        <span class="question-type-badge">${q.question_type.replace('_', ' ')}</span>
                    </div>
                    <div class="question-actions">
                        <button onclick="editQuestion(${q.id})" class="btn" style="padding: 0.25rem 0.5rem;">Edit</button>
                        <button onclick="duplicateQuestion(${q.id})" class="btn" style="padding: 0.25rem 0.5rem;">Duplicate</button>
                        <button onclick="deleteQuestion(${q.id})" class="btn btn-danger" style="padding: 0.25rem 0.5rem;">Delete</button>
                    </div>
                </div>
                
                <div style="margin-left: 2rem;">
                    <p style="margin: 0.5rem 0;">${q.question_text}</p>
                    
                    ${q.question_type === 'multiple_choice' && q.options && q.options.length > 0 ? `
                        <div class="options-list">
                            ${q.options.map((opt, optIdx) => `
                                <div class="option-item">
                                    <span class="option-index">${optIdx}</span>
                                    ${opt.option_text}
                                    ${opt.audio_file ? '<span style="margin-left: 0.5rem;">ðŸ”Š</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div>
                        ${q.pre_script ? `<span class="skip-logic-tag">Skip Logic: ${q.pre_script}</span>` : ''}
                        ${q.validation_script ? `<span class="validation-tag">Validation: ${q.validation_script}</span>` : ''}
                        ${q.audio_file ? `<span style="margin-left: 0.5rem;">ðŸ”Š ${q.audio_file}</span>` : ''}
                    </div>
                </div>
            </div>
        `).join('')}
        ${questions.length === 0 ? '<p style="text-align: center; color: #666; padding: 2rem;">No questions added yet. Click "Add Question" to start building your survey.</p>' : ''}
    </div>
</div>

<!-- Enhanced Question Modal -->
<div id="questionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
    <div style="background: white; max-width: 900px; margin: 50px auto; padding: 2rem; border-radius: 8px;">
        <h3 id="modalTitle">Add Question</h3>
        
        <!-- Language Tabs -->
        <div class="language-tabs">
            <button type="button" class="language-tab active" data-lang="en" onclick="switchLanguage('en')">English</button>
            <button type="button" class="language-tab" data-lang="primary" onclick="switchLanguage('primary')">Primary Language</button>
        </div>
        
        <form id="questionForm">
            <input type="hidden" id="questionId">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Short Name (for skip logic) <span style="color: red;">*</span></label>
                    <input type="text" id="shortName" class="form-control" placeholder="e.g., q1_age, q2_gender" required pattern="^[a-zA-Z0-9_]+$" oninput="validateShortName(this)">
                    <small style="color: #666;">Used in skip logic expressions (only letters, numbers, and underscores)</small>
                    <small id="shortNameError" style="color: red; display: none;">Only alphanumeric characters and underscores allowed</small>
                </div>
                <div class="form-group">
                    <label>Question Order <span style="color: red;">*</span></label>
                    <input type="number" id="questionIndex" class="form-control" placeholder="0" required min="0">
                    <small style="color: #666;">Position in survey (0-based)</small>
                </div>
            </div>
            
            <div class="form-group">
                <label>Question Text (English) <span style="color: red;">*</span></label>
                <textarea id="questionText" class="form-control" rows="3" placeholder="Enter the question text" required></textarea>
            </div>
            
            <div class="form-group" id="primaryLanguageGroup" style="display: none;">
                <label>Question Text (Primary Language)</label>
                <textarea id="primaryLanguageText" class="form-control" rows="3" placeholder="Enter the question in primary language"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Question Type <span style="color: red;">*</span></label>
                    <select id="questionType" class="form-control" onchange="toggleOptionsSection()">
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="numeric">Numeric</option>
                        <option value="text">Text</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Audio File (optional)</label>
                    <input type="text" id="audioFile" class="form-control" placeholder="question1.mp3">
                </div>
            </div>
            
            <div id="optionsSection" class="form-group">
                <label>Answer Options</label>
                <div id="optionsList">
                    <div class="option-item-input" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <input type="text" class="form-control option-text-en" placeholder="Option text (English)" style="flex: 1;">
                        <input type="text" class="form-control option-text-primary" placeholder="Primary language" style="flex: 1; display: none;">
                        <input type="text" class="form-control option-audio" placeholder="Audio file" style="width: 150px;">
                        <button type="button" onclick="addOption()" class="btn" style="padding: 0.5rem;">+</button>
                    </div>
                </div>
                <small style="color: #666;">Options will be indexed automatically (0, 1, 2, ...)</small>
            </div>
            
            <div class="form-group">
                <label>Skip Logic (JEXL expression)</label>
                <input type="text" id="preScript" class="form-control" placeholder="e.g., q1_age >= 18 && q2_gender == 1">
                <small style="color: #666;">Question will only show if this expression evaluates to true</small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Validation Script (JEXL expression)</label>
                    <input type="text" id="validationScript" class="form-control" placeholder="e.g., value >= 0 && value <= 120">
                    <small style="color: #666;">Answer must satisfy this condition</small>
                </div>
                <div class="form-group">
                    <label>Validation Error Message</label>
                    <input type="text" id="validationErrorText" class="form-control" placeholder="Invalid answer" value="Invalid answer">
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn">Save Question</button>
                <button type="button" onclick="closeQuestionModal()" class="btn btn-danger">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
const surveyId = ${survey.id};
let currentLanguage = 'en';
let questionOrder = ${JSON.stringify(questions.map(q => q.id))};

// Drag and Drop functionality
let draggedElement = null;

document.querySelectorAll('.question-item').forEach(item => {
    item.addEventListener('dragstart', handleDragStart);
    item.addEventListener('dragend', handleDragEnd);
    item.addEventListener('dragover', handleDragOver);
    item.addEventListener('drop', handleDrop);
    item.addEventListener('dragenter', handleDragEnter);
    item.addEventListener('dragleave', handleDragLeave);
});

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.question-item').forEach(item => {
        item.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    this.classList.add('drag-over');
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    if (draggedElement !== this) {
        const allItems = Array.from(document.querySelectorAll('.question-item'));
        const draggedIndex = allItems.indexOf(draggedElement);
        const targetIndex = allItems.indexOf(this);
        
        if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedElement, this);
        }
        
        // Update question order array
        updateQuestionOrder();
    }
    
    return false;
}

function updateQuestionOrder() {
    const items = document.querySelectorAll('.question-item');
    questionOrder = Array.from(items).map(item => parseInt(item.dataset.questionId));
    
    // Update visual numbers
    items.forEach((item, index) => {
        const numberSpan = item.querySelector('.question-number');
        if (numberSpan) {
            numberSpan.textContent = 'Q' + (index + 1);
        }
    });
}

async function reorderQuestions() {
    try {
        const response = await fetch('/api/admin/survey-config/' + surveyId + '/reorder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ questionOrder })
        });
        
        if (response.ok) {
            alert('Question order saved successfully');
        } else {
            const result = await response.json();
            alert('Failed to save order: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Validate short name input
function validateShortName(input) {
    const pattern = /^[a-zA-Z0-9_]*$/;
    const errorMsg = document.getElementById('shortNameError');
    
    if (!pattern.test(input.value)) {
        // Remove invalid characters
        input.value = input.value.replace(/[^a-zA-Z0-9_]/g, '');
        errorMsg.style.display = 'block';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 3000);
    }
}

// Language switching
function switchLanguage(lang) {
    currentLanguage = lang;
    document.querySelectorAll('.language-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.lang === lang);
    });
    
    const showPrimary = lang === 'primary';
    document.getElementById('primaryLanguageGroup').style.display = showPrimary ? 'block' : 'none';
    
    // Toggle option language inputs
    document.querySelectorAll('.option-text-en').forEach(input => {
        input.style.display = showPrimary ? 'none' : 'block';
    });
    document.querySelectorAll('.option-text-primary').forEach(input => {
        input.style.display = showPrimary ? 'block' : 'none';
    });
}

// Update survey details
document.getElementById('surveyForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        name: document.getElementById('surveyName').value,
        description: document.getElementById('surveyDescription').value
    };
    
    try {
        const response = await fetch('/api/admin/survey-config/' + surveyId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Survey details updated');
        } else {
            const result = await response.json();
            alert('Failed to update: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Question modal functions
function showAddQuestion() {
    document.getElementById('modalTitle').textContent = 'Add Question';
    document.getElementById('questionId').value = '';
    document.getElementById('questionForm').reset();
    
    // Set next question index
    const nextIndex = ${questions.length};
    document.getElementById('questionIndex').value = nextIndex;
    document.getElementById('validationErrorText').value = 'Invalid answer';
    
    // Reset options
    document.getElementById('optionsList').innerHTML = \`
        <div class="option-item-input" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <input type="text" class="form-control option-text-en" placeholder="Option text (English)" style="flex: 1;">
            <input type="text" class="form-control option-text-primary" placeholder="Primary language" style="flex: 1; display: none;">
            <input type="text" class="form-control option-audio" placeholder="Audio file" style="width: 150px;">
            <button type="button" onclick="addOption()" class="btn" style="padding: 0.5rem;">+</button>
        </div>
    \`;
    
    document.getElementById('questionModal').style.display = 'block';
    switchLanguage('en');
}

function editQuestion(questionId) {
    const questions = ${JSON.stringify(questions)};
    const question = questions.find(q => q.id === questionId);
    
    if (!question) return;
    
    document.getElementById('modalTitle').textContent = 'Edit Question';
    document.getElementById('questionId').value = questionId;
    document.getElementById('shortName').value = question.short_name;
    document.getElementById('questionText').value = question.question_text;
    document.getElementById('primaryLanguageText').value = question.primary_language_text || '';
    document.getElementById('questionType').value = question.question_type;
    document.getElementById('questionIndex').value = question.question_index;
    document.getElementById('preScript').value = question.pre_script || '';
    document.getElementById('validationScript').value = question.validation_script || '';
    document.getElementById('validationErrorText').value = question.validation_error_text || 'Invalid answer';
    document.getElementById('audioFile').value = question.audio_file || '';
    
    // Load options if multiple choice
    const optionsList = document.getElementById('optionsList');
    optionsList.innerHTML = '';
    
    if (question.question_type === 'multiple_choice' && question.options) {
        question.options.forEach((opt, idx) => {
            const div = document.createElement('div');
            div.className = 'option-item-input';
            div.style = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            div.innerHTML = \`
                <input type="text" class="form-control option-text-en" value="\${opt.option_text}" placeholder="Option text (English)" style="flex: 1;">
                <input type="text" class="form-control option-text-primary" value="\${opt.primary_language_text || ''}" placeholder="Primary language" style="flex: 1; display: none;">
                <input type="text" class="form-control option-audio" value="\${opt.audio_file || ''}" placeholder="Audio file" style="width: 150px;">
                <button type="button" onclick="\${idx === 0 ? 'addOption()' : 'removeOption(this)'}" class="btn \${idx === 0 ? '' : 'btn-danger'}" style="padding: 0.5rem;">\${idx === 0 ? '+' : '-'}</button>
            \`;
            optionsList.appendChild(div);
        });
    }
    
    if (!question.options || question.options.length === 0) {
        addOption();
    }
    
    toggleOptionsSection();
    document.getElementById('questionModal').style.display = 'block';
    switchLanguage('en');
}

function duplicateQuestion(questionId) {
    const questions = ${JSON.stringify(questions)};
    const question = questions.find(q => q.id === questionId);
    
    if (!question) return;
    
    const newName = prompt('Enter short name for the duplicated question:', question.short_name + '_copy');
    if (!newName) return;
    
    // Prepare question data
    const data = {
        short_name: newName,
        question_text: question.question_text + ' (Copy)',
        question_type: question.question_type,
        question_index: questions.length,
        pre_script: question.pre_script,
        validation_script: question.validation_script,
        validation_error_text: question.validation_error_text,
        audio_file: question.audio_file,
        primary_language_text: question.primary_language_text,
        options: question.options ? question.options.map(opt => ({
            text: opt.option_text,
            audio_file: opt.audio_file,
            primary_language_text: opt.primary_language_text
        })) : []
    };
    
    // Save duplicated question
    fetch('/api/admin/survey-config/' + surveyId + '/questions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            alert('Question duplicated successfully');
            location.reload();
        } else {
            return response.json().then(result => {
                alert('Failed to duplicate: ' + result.error);
            });
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function closeQuestionModal() {
    document.getElementById('questionModal').style.display = 'none';
}

function toggleOptionsSection() {
    const type = document.getElementById('questionType').value;
    document.getElementById('optionsSection').style.display = 
        type === 'multiple_choice' ? 'block' : 'none';
}

function addOption() {
    const optionsList = document.getElementById('optionsList');
    const div = document.createElement('div');
    div.className = 'option-item-input';
    div.style = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
    div.innerHTML = \`
        <input type="text" class="form-control option-text-en" placeholder="Option text (English)" style="flex: 1; \${currentLanguage === 'primary' ? 'display: none;' : ''}">
        <input type="text" class="form-control option-text-primary" placeholder="Primary language" style="flex: 1; \${currentLanguage === 'en' ? 'display: none;' : ''}">
        <input type="text" class="form-control option-audio" placeholder="Audio file" style="width: 150px;">
        <button type="button" onclick="removeOption(this)" class="btn btn-danger" style="padding: 0.5rem;">-</button>
    \`;
    optionsList.appendChild(div);
}

function removeOption(button) {
    button.parentElement.remove();
}

async function deleteQuestion(questionId) {
    if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) return;
    
    try {
        const response = await fetch('/api/admin/survey-config/' + surveyId + '/questions/' + questionId, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Question deleted successfully');
            location.reload();
        } else {
            const result = await response.json();
            alert('Failed to delete: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Save question
document.getElementById('questionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const shortName = document.getElementById('shortName').value;
    const shortNamePattern = /^[a-zA-Z0-9_]+$/;
    
    // Validate short name
    if (!shortNamePattern.test(shortName)) {
        alert('Short name can only contain letters, numbers, and underscores');
        document.getElementById('shortName').focus();
        return;
    }
    
    const questionId = document.getElementById('questionId').value;
    const isEdit = !!questionId;
    
    // Collect options
    const options = [];
    if (document.getElementById('questionType').value === 'multiple_choice') {
        document.querySelectorAll('#optionsList .option-item-input').forEach((item, index) => {
            const textEn = item.querySelector('.option-text-en').value.trim();
            const textPrimary = item.querySelector('.option-text-primary').value.trim();
            const audioFile = item.querySelector('.option-audio').value.trim();
            
            if (textEn) {
                options.push({
                    text: textEn,
                    audio_file: audioFile || null,
                    primary_language_text: textPrimary || null,
                    option_index: index
                });
            }
        });
    }
    
    const data = {
        short_name: document.getElementById('shortName').value,
        question_text: document.getElementById('questionText').value,
        primary_language_text: document.getElementById('primaryLanguageText').value || null,
        question_type: document.getElementById('questionType').value,
        question_index: parseInt(document.getElementById('questionIndex').value),
        pre_script: document.getElementById('preScript').value || null,
        validation_script: document.getElementById('validationScript').value || null,
        validation_error_text: document.getElementById('validationErrorText').value || 'Invalid answer',
        audio_file: document.getElementById('audioFile').value || null,
        options: options
    };
    
    try {
        const url = isEdit ? 
            '/api/admin/survey-config/' + surveyId + '/questions/' + questionId :
            '/api/admin/survey-config/' + surveyId + '/questions';
            
        const response = await fetch(url, {
            method: isEdit ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert(isEdit ? 'Question updated successfully' : 'Question added successfully');
            location.reload();
        } else {
            const result = await response.json();
            alert('Failed to save: ' + (result.errors ? result.errors.map(e => e.msg).join(', ') : result.error));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    toggleOptionsSection();
});
</script>
` %>
<%- include('../layouts/main', { body: body }) %>