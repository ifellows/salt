<% var body = ` 
<h2>Facilities Management</h2>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Registered Facilities</h3>
        <button class="btn" onclick="showAddFacilityForm()">Add New Facility</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Location</th>
                <th>API Key</th>
                <th>Uploads</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            ${facilities.map(facility => `
                <tr>
                    <td>${facility.name}</td>
                    <td>${facility.location || '-'}</td>
                    <td>
                        <code style="background: #f5f5f5; padding: 0.25rem;">${facility.api_key.substring(0, 20)}...</code>
                        <button onclick="copyApiKey('${facility.api_key}')" class="btn" style="padding: 0.25rem 0.5rem; margin-left: 0.5rem;">Copy</button>
                    </td>
                    <td>${facility.upload_count}</td>
                    <td>
                        <button onclick="regenerateKey(${facility.id})" class="btn" style="padding: 0.25rem 0.5rem;">New Key</button>
                    </td>
                </tr>
            `).join('')}
            ${facilities.length === 0 ? '<tr><td colspan="5" style="text-align: center;">No facilities registered</td></tr>' : ''}
        </tbody>
    </table>
</div>

<div id="addFacilityModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; max-width: 500px; margin: 100px auto; padding: 2rem; border-radius: 8px;">
        <h3>Add New Facility</h3>
        <form id="addFacilityForm">
            <input type="text" name="name" placeholder="Facility Name" required style="width: 100%; padding: 0.5rem; margin: 1rem 0;">
            <input type="text" name="location" placeholder="Location (optional)" style="width: 100%; padding: 0.5rem; margin: 1rem 0;">
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn">Add Facility</button>
                <button type="button" onclick="hideAddFacilityForm()" class="btn btn-danger">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddFacilityForm() {
    document.getElementById('addFacilityModal').style.display = 'block';
}

function hideAddFacilityForm() {
    document.getElementById('addFacilityModal').style.display = 'none';
}

function copyApiKey(key) {
    navigator.clipboard.writeText(key);
    alert('API key copied to clipboard');
}

async function regenerateKey(facilityId) {
    if (!confirm('Are you sure you want to regenerate the API key? The old key will stop working.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/admin/facilities/' + facilityId + '/regenerate-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('New API key: ' + result.api_key);
            location.reload();
        } else {
            alert('Failed to regenerate key: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

document.getElementById('addFacilityForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/admin/facilities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Facility added successfully. API Key: ' + result.api_key);
            location.reload();
        } else {
            alert('Failed to add facility: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});
</script>
` %>
<%- include('../layouts/main', { body: body }) %>