<% var body = ` 
<h2>Facilities Management</h2>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Registered Facilities</h3>
        <button class="btn" onclick="showAddFacilityForm()">Add New Facility</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Location</th>
                <th>API Key</th>
                <th>Non-Coupon Allowed</th>
                <th>Coupons to Issue</th>
                <th>Seed Recruitment</th>
                <th>Uploads</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            ${facilities.map(facility => `
                <tr>
                    <td>${facility.name}</td>
                    <td>${facility.location || '-'}</td>
                    <td>
                        <code style="background: #f5f5f5; padding: 0.25rem;">${facility.api_key.substring(0, 20)}...</code>
                        <button onclick="copyApiKey('${facility.api_key}')" class="btn" style="padding: 0.25rem 0.5rem; margin-left: 0.5rem;">Copy</button>
                    </td>
                    <td>
                        <span style="color: ${facility.allow_non_coupon_participants ? 'green' : 'red'}; font-weight: bold;">
                            ${facility.allow_non_coupon_participants ? 'Yes' : 'No'}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <strong>${facility.coupons_to_issue || 3}</strong>
                    </td>
                    <td>
                        <span style="color: ${facility.seed_recruitment_active ? 'green' : 'gray'}; font-weight: bold;">
                            ${facility.seed_recruitment_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${facility.upload_count}</td>
                    <td>
                        <button onclick="editFacility(${facility.id}, '${facility.name}', '${facility.location || ''}', ${facility.allow_non_coupon_participants ? 'true' : 'false'}, ${facility.coupons_to_issue || 3}, ${facility.seed_recruitment_active ? 'true' : 'false'}, ${facility.seed_contact_rate_days || 7}, ${facility.seed_recruitment_window_min_days || 0}, ${facility.seed_recruitment_window_max_days || 730})" class="btn" style="padding: 0.25rem 0.5rem;">Edit</button>
                        <button onclick="regenerateKey(${facility.id})" class="btn" style="padding: 0.25rem 0.5rem;">New Key</button>
                    </td>
                </tr>
            `).join('')}
            ${facilities.length === 0 ? '<tr><td colspan="8" style="text-align: center;">No facilities registered</td></tr>' : ''}
        </tbody>
    </table>
</div>

<div id="addFacilityModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="background: white; max-width: 500px; margin: 2rem auto; padding: 2rem; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
        <h3>Add New Facility</h3>
        <form id="addFacilityForm">
            <input type="text" name="name" placeholder="Facility Name" required style="width: 100%; padding: 0.5rem; margin: 1rem 0;">
            <input type="text" name="location" placeholder="Location (optional)" style="width: 100%; padding: 0.5rem; margin: 1rem 0;">
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" name="allow_non_coupon_participants" checked style="margin-right: 0.5rem;">
                    Allow participants without coupons
                </label>
            </div>
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">Number of coupons to issue:</label>
                <input type="number" name="coupons_to_issue" value="3" min="0" max="10" required style="width: 100%; padding: 0.5rem;">
            </div>
            
            <hr style="margin: 1.5rem 0;">
            <h4>Seed Recruitment Settings</h4>
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" name="seed_recruitment_active" style="margin-right: 0.5rem;">
                    Enable seed recruitment
                </label>
            </div>
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">Contact rate (days between contacts):</label>
                <input type="number" name="seed_contact_rate_days" value="7" min="1" max="365" style="width: 100%; padding: 0.5rem;">
            </div>
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">Recruitment window minimum (days):</label>
                <input type="number" name="seed_recruitment_window_min_days" value="0" min="0" style="width: 100%; padding: 0.5rem;">
            </div>
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">Recruitment window maximum (days):</label>
                <input type="number" name="seed_recruitment_window_max_days" value="730" min="1" max="1095" style="width: 100%; padding: 0.5rem;">
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn">Add Facility</button>
                <button type="button" onclick="hideAddFacilityForm()" class="btn btn-danger">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="editFacilityModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="background: white; max-width: 500px; margin: 2rem auto; padding: 2rem; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
        <h3>Edit Facility</h3>
        <form id="editFacilityForm">
            <input type="hidden" name="id">
            <input type="text" name="name" placeholder="Facility Name" required style="width: 100%; padding: 0.5rem; margin: 1rem 0;">
            <input type="text" name="location" placeholder="Location (optional)" style="width: 100%; padding: 0.5rem; margin: 1rem 0;">
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" name="allow_non_coupon_participants" style="margin-right: 0.5rem;">
                    Allow participants without coupons
                </label>
            </div>
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">Number of coupons to issue:</label>
                <input type="number" name="coupons_to_issue" value="3" min="0" max="10" required style="width: 100%; padding: 0.5rem;">
            </div>
            
            <hr style="margin: 1.5rem 0;">
            <h4>Seed Recruitment Settings</h4>
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" name="seed_recruitment_active" style="margin-right: 0.5rem;">
                    Enable seed recruitment
                </label>
            </div>
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">Contact rate (days between contacts):</label>
                <input type="number" name="seed_contact_rate_days" value="7" min="1" max="365" style="width: 100%; padding: 0.5rem;">
            </div>
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">Recruitment window minimum (days):</label>
                <input type="number" name="seed_recruitment_window_min_days" value="0" min="0" style="width: 100%; padding: 0.5rem;">
            </div>
            
            <div style="margin: 1rem 0;">
                <label style="display: block; margin-bottom: 0.5rem;">Recruitment window maximum (days):</label>
                <input type="number" name="seed_recruitment_window_max_days" value="730" min="1" max="1095" style="width: 100%; padding: 0.5rem;">
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn">Update Facility</button>
                <button type="button" onclick="hideEditFacilityForm()" class="btn btn-danger">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddFacilityForm() {
    document.getElementById('addFacilityModal').style.display = 'block';
}

function hideAddFacilityForm() {
    document.getElementById('addFacilityModal').style.display = 'none';
}

function editFacility(id, name, location, allowNonCoupon, couponsToIssue, seedRecruitmentActive, seedContactRateDays, seedRecruitmentWindowMinDays, seedRecruitmentWindowMaxDays) {
    const form = document.getElementById('editFacilityForm');
    form.id.value = id;
    form.name.value = name;
    form.location.value = location;
    form.allow_non_coupon_participants.checked = allowNonCoupon;
    form.coupons_to_issue.value = couponsToIssue;
    form.seed_recruitment_active.checked = seedRecruitmentActive;
    form.seed_contact_rate_days.value = seedContactRateDays || 7;
    form.seed_recruitment_window_min_days.value = seedRecruitmentWindowMinDays || 0;
    form.seed_recruitment_window_max_days.value = seedRecruitmentWindowMaxDays || 730;
    document.getElementById('editFacilityModal').style.display = 'block';
}

function hideEditFacilityForm() {
    document.getElementById('editFacilityModal').style.display = 'none';
}

function copyApiKey(key) {
    navigator.clipboard.writeText(key);
    alert('API key copied to clipboard');
}

async function regenerateKey(facilityId) {
    if (!confirm('Are you sure you want to regenerate the API key? The old key will stop working.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/admin/facilities/' + facilityId + '/regenerate-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('New API key: ' + result.api_key);
            location.reload();
        } else {
            alert('Failed to regenerate key: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

document.getElementById('addFacilityForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    // Convert checkbox value to boolean
    data.allow_non_coupon_participants = formData.has('allow_non_coupon_participants');
    data.seed_recruitment_active = formData.has('seed_recruitment_active');
    // Convert numeric fields
    data.seed_contact_rate_days = parseInt(data.seed_contact_rate_days, 10) || 7;
    data.seed_recruitment_window_min_days = parseInt(data.seed_recruitment_window_min_days, 10) || 0;
    data.seed_recruitment_window_max_days = parseInt(data.seed_recruitment_window_max_days, 10) || 730;
    
    // Remove NaN values
    Object.keys(data).forEach(key => {
        if (typeof data[key] === 'number' && isNaN(data[key])) {
            delete data[key];
        }
    });
    
    try {
        const response = await fetch('/api/admin/facilities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Facility added successfully. API Key: ' + result.api_key);
            location.reload();
        } else {
            alert('Failed to add facility: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

document.getElementById('editFacilityForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    const facilityId = data.id;
    delete data.id;
    
    // Convert checkbox value to boolean
    data.allow_non_coupon_participants = formData.has('allow_non_coupon_participants');
    data.seed_recruitment_active = formData.has('seed_recruitment_active');
    // Ensure numeric fields are numbers
    data.coupons_to_issue = parseInt(data.coupons_to_issue, 10);
    data.seed_contact_rate_days = parseInt(data.seed_contact_rate_days, 10) || 7;
    data.seed_recruitment_window_min_days = parseInt(data.seed_recruitment_window_min_days, 10) || 0;
    data.seed_recruitment_window_max_days = parseInt(data.seed_recruitment_window_max_days, 10) || 730;
    
    // Remove NaN values
    Object.keys(data).forEach(key => {
        if (typeof data[key] === 'number' && isNaN(data[key])) {
            delete data[key];
        }
    });
    
    console.log('Sending update:', data);  // Debug log
    
    try {
        const response = await fetch('/api/admin/facilities/' + facilityId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Facility updated successfully');
            location.reload();
        } else {
            alert('Failed to update facility: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});
</script>
` %>
<%- include('../layouts/main', { body: body }) %>