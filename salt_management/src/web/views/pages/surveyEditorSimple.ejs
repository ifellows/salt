<%
// Prepare the questions data
const questionsData = questions.map(q => {
    const texts = typeof q.question_text_json === 'string' ? JSON.parse(q.question_text_json) : q.question_text_json || {};
    const audioFiles = typeof q.audio_files_json === 'string' ? JSON.parse(q.audio_files_json) : q.audio_files_json || {};
    const validationError = typeof q.validation_error_json === 'string' ? JSON.parse(q.validation_error_json) : q.validation_error_json || {};
    return {
        id: q.id,
        question_index: q.question_index,
        short_name: q.short_name,
        question_type: q.question_type,
        texts: texts,
        audioFiles: audioFiles,
        pre_script: q.pre_script,
        validation_script: q.validation_script,
        validation_error: validationError,
        options: q.options || []
    };
});

// Parse survey languages
const surveyLanguages = typeof survey.languages === 'string' ? JSON.parse(survey.languages) : survey.languages || ['en'];

// Build the body HTML
let bodyHtml = '<link rel="stylesheet" href="/css/survey-editor.css">\n';
bodyHtml += '<script src="/js/lamejs/lame.min.js"></script>\n';
bodyHtml += '<h2>Survey Editor: ' + survey.name + ' (v' + survey.version + ')</h2>\n';

// Survey info card
bodyHtml += '<div class="card">\n';
bodyHtml += '    <h3>Survey Information</h3>\n';
bodyHtml += '    <p><strong>Name:</strong> ' + survey.name + '</p>\n';
bodyHtml += '    <p><strong>Version:</strong> ' + survey.version + '</p>\n';
bodyHtml += '    <p><strong>Description:</strong> ' + (survey.description || 'No description') + '</p>\n';
bodyHtml += '    <p><strong>Status:</strong> ' + (survey.is_active ? 'Active' : 'Inactive') + '</p>\n';
bodyHtml += '    <p><strong>Languages:</strong> ' + surveyLanguages.join(', ') + '</p>\n';
bodyHtml += '</div>\n';

// Questions card
bodyHtml += '<div class="card">\n';
bodyHtml += '    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">\n';
bodyHtml += '        <h3>Questions (' + questions.length + ')</h3>\n';
bodyHtml += '        <div>\n';
bodyHtml += '            <button onclick="newQuestion()" class="btn" style="margin-right: 0.5rem;">New Question</button>\n';
bodyHtml += '            <button onclick="saveQuestionOrder()" class="btn">Save Order</button>\n';
bodyHtml += '        </div>\n';
bodyHtml += '    </div>\n';
bodyHtml += '    <div id="questionsList">\n';

// Add each question
questionsData.forEach((q, idx) => {
    bodyHtml += '        <div class="question-item" draggable="true" data-question-id="' + q.id + '" data-question-index="' + q.question_index + '">\n';
    bodyHtml += '            <div class="question-header">\n';
    bodyHtml += '                <div style="flex: 1;">\n';
    bodyHtml += '                    <span class="drag-handle">‚â°</span>\n';
    bodyHtml += '                    <span class="question-number">Q' + (q.question_index + 1) + '</span>\n';
    bodyHtml += '                    <strong>' + q.short_name + '</strong>\n';
    bodyHtml += '                    <span class="question-type-badge">' + q.question_type.replace('_', ' ') + '</span>\n';
    bodyHtml += '                </div>\n';
    bodyHtml += '                <button onclick="editQuestion(' + q.id + ')" class="btn btn-sm">Edit</button>\n';
    bodyHtml += '            </div>\n';
    bodyHtml += '            <div style="margin-left: 2rem;">\n';
    // Get the first language text (prioritize English if available)
    const primaryText = q.texts.English || q.texts[Object.keys(q.texts)[0]] || 'No text';
    bodyHtml += '                <p style="margin: 0.5rem 0;">' + primaryText + '</p>\n';
    
    // Show other language texts
    Object.keys(q.texts).filter(lang => lang.toLowerCase() !== 'english').forEach(lang => {
        bodyHtml += '                <p style="margin: 0.25rem 0; color: #666; font-size: 0.9rem;">\n';
        bodyHtml += '                    <strong>' + lang + ':</strong> ' + q.texts[lang] + '\n';
        bodyHtml += '                </p>\n';
    });
    
    // Show options for multiple choice
    if (q.question_type === 'multiple_choice' && q.options && q.options.length > 0) {
        bodyHtml += '                <div class="options-list">\n';
        q.options.forEach((opt, optIdx) => {
            const optTexts = typeof opt.option_text_json === 'string' ? 
                JSON.parse(opt.option_text_json) : opt.option_text_json || {};
            bodyHtml += '                    <div class="option-item">\n';
            bodyHtml += '                        <span class="option-index">' + optIdx + '</span>\n';
            const optPrimaryText = optTexts.English || optTexts[Object.keys(optTexts)[0]] || 'No text';
            bodyHtml += '                        ' + optPrimaryText + '\n';
            bodyHtml += '                    </div>\n';
            });
        bodyHtml += '                </div>\n';
    }
    
    // Show skip logic and validation
    bodyHtml += '                <div>\n';
    if (q.pre_script) {
        bodyHtml += '                    <span class="skip-logic-tag">Skip Logic: ' + q.pre_script + '</span>\n';
    }
    if (q.validation_script) {
        bodyHtml += '                    <span class="validation-tag">Validation: ' + q.validation_script + '</span>\n';
    }
    bodyHtml += '                </div>\n';
    bodyHtml += '            </div>\n';
    bodyHtml += '        </div>\n';
});

if (questions.length === 0) {
    bodyHtml += '        <p style="text-align: center; color: #666; padding: 2rem;">No questions in this survey.</p>\n';
}

bodyHtml += '    </div>\n';
bodyHtml += '</div>\n';

// Add edit modal
bodyHtml += '<div id="editModal" class="modal">\n';
bodyHtml += '    <div class="modal-content">\n';
bodyHtml += '        <div class="modal-header">\n';
bodyHtml += '            <h3 id="modalTitle">Edit Question</h3>\n';
bodyHtml += '            <span class="close" onclick="closeModal()">&times;</span>\n';
bodyHtml += '        </div>\n';
bodyHtml += '        <div class="modal-body">\n';
bodyHtml += '            <form id="editForm">\n';
bodyHtml += '                <input type="hidden" id="questionId">\n';
bodyHtml += '                \n';
bodyHtml += '                <div class="form-group">\n';
bodyHtml += '                    <label>Short Name</label>\n';
bodyHtml += '                    <input type="text" id="shortName" class="form-control" pattern="^[a-zA-Z0-9_]+$" required>\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div class="form-group">\n';
bodyHtml += '                    <label>Question Type</label>\n';
bodyHtml += '                    <select id="questionType" class="form-control" onchange="toggleOptionsSection()">\n';
bodyHtml += '                        <option value="multiple_choice">Multiple Choice</option>\n';
bodyHtml += '                        <option value="numeric">Numeric</option>\n';
bodyHtml += '                        <option value="text">Text</option>\n';
bodyHtml += '                    </select>\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div id="languageTexts">\n';
bodyHtml += '                    <label>Question Text</label>\n';
// Add input for each language
surveyLanguages.forEach(lang => {
    const langId = lang.replace(/\s+/g, '_');
    bodyHtml += '                    <div class="form-group">\n';
    bodyHtml += '                        <div style="display: flex; gap: 0.5rem; align-items: center;">\n';
    bodyHtml += '                            <input type="text" id="text_' + langId + '" class="form-control" placeholder="' + lang + ' text" ' + (lang.toLowerCase() === 'english' ? 'required' : '') + ' style="flex: 1;">\n';
    bodyHtml += '                            <button type="button" id="record_' + langId + '" onclick="toggleRecording(\'' + langId + '\')" class="btn btn-sm" style="width: 100px;">üé§ Record</button>\n';
    bodyHtml += '                            <button type="button" id="play_' + langId + '" onclick="playAudio(\'' + langId + '\')" class="btn btn-sm" style="display: none;">‚ñ∂Ô∏è Play</button>\n';
    bodyHtml += '                        </div>\n';
    bodyHtml += '                        <input type="hidden" id="audio_' + langId + '">\n';
    bodyHtml += '                    </div>\n';
});
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div id="optionsSection" style="display: none;">\n';
bodyHtml += '                    <label>Options</label>\n';
bodyHtml += '                    <div id="optionsList"></div>\n';
bodyHtml += '                    <button type="button" onclick="addOption()" class="btn btn-sm">Add Option</button>\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div class="form-group">\n';
bodyHtml += '                    <label>Skip Logic (JEXL expression)</label>\n';
bodyHtml += '                    <input type="text" id="preScript" class="form-control" placeholder="e.g., age >= 18">\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div class="form-group">\n';
bodyHtml += '                    <label>Validation Script</label>\n';
bodyHtml += '                    <input type="text" id="validationScript" class="form-control" placeholder="e.g., value >= 0 && value <= 100">\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '            </form>\n';
bodyHtml += '        </div>\n';
bodyHtml += '        <div class="modal-footer">\n';
bodyHtml += '            <button onclick="saveQuestion()" class="btn">Save</button>\n';
bodyHtml += '            <button onclick="closeModal()" class="btn btn-danger">Cancel</button>\n';
bodyHtml += '        </div>\n';
bodyHtml += '    </div>\n';
bodyHtml += '</div>\n';

// Add CSS styles
bodyHtml += '<style>\n';
bodyHtml += '.btn-sm { padding: 0.25rem 0.5rem; font-size: 0.9rem; }\n';
bodyHtml += '.question-item { background: #f8f8f8; padding: 1rem; margin-bottom: 0.5rem; border-radius: 4px; cursor: move; }\n';
bodyHtml += '.question-item.dragging { opacity: 0.5; }\n';
bodyHtml += '.question-item.drag-over { border-top: 3px solid #3498db; }\n';
bodyHtml += '.question-header { display: flex; justify-content: space-between; align-items: center; }\n';
bodyHtml += '.drag-handle { color: #666; margin-right: 0.5rem; font-size: 1.2rem; }\n';
bodyHtml += '.question-number { background: #3498db; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; margin-right: 0.5rem; }\n';
bodyHtml += '.question-type-badge { background: #95a5a6; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; margin-left: 0.5rem; font-size: 0.8rem; }\n';
bodyHtml += '.options-list { margin: 0.5rem 0; padding-left: 1rem; }\n';
bodyHtml += '.option-item { padding: 0.25rem 0; }\n';
bodyHtml += '.option-index { background: #ecf0f1; padding: 0.2rem 0.4rem; border-radius: 3px; margin-right: 0.5rem; }\n';
bodyHtml += '.skip-logic-tag { background: #f39c12; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; margin-right: 0.5rem; font-size: 0.8rem; }\n';
bodyHtml += '.validation-tag { background: #e74c3c; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }\n';
bodyHtml += '.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }\n';
bodyHtml += '.modal-content { background-color: #fefefe; margin: 5% auto; width: 80%; max-width: 600px; border-radius: 8px; }\n';
bodyHtml += '.modal-header { padding: 1rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }\n';
bodyHtml += '.modal-body { padding: 1rem; max-height: 60vh; overflow-y: auto; }\n';
bodyHtml += '.modal-footer { padding: 1rem; border-top: 1px solid #ddd; display: flex; gap: 0.5rem; justify-content: flex-end; }\n';
bodyHtml += '.close { font-size: 28px; font-weight: bold; cursor: pointer; }\n';
bodyHtml += '.close:hover { color: #000; }\n';
bodyHtml += '.form-group { margin-bottom: 1rem; }\n';
bodyHtml += '.form-group label { display: block; margin-bottom: 0.25rem; font-weight: bold; }\n';
bodyHtml += '.form-control { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }\n';
bodyHtml += '.option-input-group { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }\n';
bodyHtml += '.option-input-group input { flex: 1; }\n';
bodyHtml += '</style>\n';

// Add JavaScript
bodyHtml += '<script>\n';
bodyHtml += 'const surveyId = ' + survey.id + ';\n';
bodyHtml += 'const surveyLanguages = ' + JSON.stringify(surveyLanguages) + ';\n';
bodyHtml += 'let questionOrder = [' + questions.map(q => q.id).join(', ') + '];\n';
bodyHtml += 'let draggedElement = null;\n';
bodyHtml += 'let questionsData = ' + JSON.stringify(questionsData) + ';\n';
bodyHtml += '\n';

// Drag and drop functions
bodyHtml += 'function initializeDragAndDrop() {\n';
bodyHtml += '    document.querySelectorAll(".question-item").forEach(item => {\n';
bodyHtml += '        item.addEventListener("dragstart", handleDragStart);\n';
bodyHtml += '        item.addEventListener("dragend", handleDragEnd);\n';
bodyHtml += '        item.addEventListener("dragover", handleDragOver);\n';
bodyHtml += '        item.addEventListener("drop", handleDrop);\n';
bodyHtml += '        item.addEventListener("dragenter", handleDragEnter);\n';
bodyHtml += '        item.addEventListener("dragleave", handleDragLeave);\n';
bodyHtml += '    });\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDragStart(e) {\n';
bodyHtml += '    draggedElement = this;\n';
bodyHtml += '    this.classList.add("dragging");\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDragEnd(e) {\n';
bodyHtml += '    this.classList.remove("dragging");\n';
bodyHtml += '    document.querySelectorAll(".question-item").forEach(item => {\n';
bodyHtml += '        item.classList.remove("drag-over");\n';
bodyHtml += '    });\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDragOver(e) {\n';
bodyHtml += '    e.preventDefault();\n';
bodyHtml += '    return false;\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDragEnter(e) {\n';
bodyHtml += '    this.classList.add("drag-over");\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDragLeave(e) {\n';
bodyHtml += '    this.classList.remove("drag-over");\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDrop(e) {\n';
bodyHtml += '    e.stopPropagation();\n';
bodyHtml += '    \n';
bodyHtml += '    if (draggedElement !== this) {\n';
bodyHtml += '        const allItems = Array.from(document.querySelectorAll(".question-item"));\n';
bodyHtml += '        const draggedIndex = allItems.indexOf(draggedElement);\n';
bodyHtml += '        const targetIndex = allItems.indexOf(this);\n';
bodyHtml += '        \n';
bodyHtml += '        if (draggedIndex < targetIndex) {\n';
bodyHtml += '            this.parentNode.insertBefore(draggedElement, this.nextSibling);\n';
bodyHtml += '        } else {\n';
bodyHtml += '            this.parentNode.insertBefore(draggedElement, this);\n';
bodyHtml += '        }\n';
bodyHtml += '        \n';
bodyHtml += '        updateQuestionOrder();\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    return false;\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function updateQuestionOrder() {\n';
bodyHtml += '    const items = document.querySelectorAll(".question-item");\n';
bodyHtml += '    questionOrder = Array.from(items).map(item => parseInt(item.dataset.questionId));\n';
bodyHtml += '    \n';
bodyHtml += '    items.forEach((item, index) => {\n';
bodyHtml += '        const numberSpan = item.querySelector(".question-number");\n';
bodyHtml += '        if (numberSpan) {\n';
bodyHtml += '            numberSpan.textContent = "Q" + (index + 1);\n';
bodyHtml += '        }\n';
bodyHtml += '    });\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function saveQuestionOrder() {\n';
bodyHtml += '    try {\n';
bodyHtml += '        const response = await fetch("/api/admin/survey-config/" + surveyId + "/reorder", {\n';
bodyHtml += '            method: "POST",\n';
bodyHtml += '            headers: { "Content-Type": "application/json" },\n';
bodyHtml += '            body: JSON.stringify({ questionOrder })\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            alert("Question order saved");\n';
bodyHtml += '        } else {\n';
bodyHtml += '            const result = await response.json();\n';
bodyHtml += '            alert("Failed to save order: " + result.error);\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        alert("Error: " + error.message);\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';

// Modal functions
bodyHtml += 'function newQuestion() {\n';
bodyHtml += '    // Set modal title\n';
bodyHtml += '    document.getElementById("modalTitle").textContent = "New Question";\n';
bodyHtml += '    \n';
bodyHtml += '    // Clear the form for new question\n';
bodyHtml += '    document.getElementById("questionId").value = "";\n';
bodyHtml += '    document.getElementById("shortName").value = "";\n';
bodyHtml += '    document.getElementById("questionType").value = "multiple_choice";\n';
bodyHtml += '    document.getElementById("preScript").value = "";\n';
bodyHtml += '    document.getElementById("validationScript").value = "";\n';
bodyHtml += '    \n';
bodyHtml += '    // Clear text inputs and audio for each language\n';
bodyHtml += '    surveyLanguages.forEach(lang => {\n';
bodyHtml += '        const langId = lang.replace(/\\s+/g, "_");\n';
bodyHtml += '        const textInput = document.getElementById("text_" + langId);\n';
bodyHtml += '        if (textInput) textInput.value = "";\n';
bodyHtml += '        \n';
bodyHtml += '        const audioInput = document.getElementById("audio_" + langId);\n';
bodyHtml += '        if (audioInput) audioInput.value = "";\n';
bodyHtml += '        \n';
bodyHtml += '        const playBtn = document.getElementById("play_" + langId);\n';
bodyHtml += '        if (playBtn) playBtn.style.display = "none";\n';
bodyHtml += '    });\n';
bodyHtml += '    \n';
bodyHtml += '    // Clear options\n';
bodyHtml += '    document.getElementById("optionsList").innerHTML = "";\n';
bodyHtml += '    \n';
bodyHtml += '    toggleOptionsSection();\n';
bodyHtml += '    document.getElementById("editModal").style.display = "block";\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function editQuestion(questionId) {\n';
bodyHtml += '    // Set modal title\n';
bodyHtml += '    document.getElementById("modalTitle").textContent = "Edit Question";\n';
bodyHtml += '    \n';
bodyHtml += '    const question = questionsData.find(q => q.id === questionId);\n';
bodyHtml += '    if (!question) return;\n';
bodyHtml += '    \n';
bodyHtml += '    document.getElementById("questionId").value = questionId;\n';
bodyHtml += '    document.getElementById("shortName").value = question.short_name;\n';
bodyHtml += '    document.getElementById("questionType").value = question.question_type;\n';
bodyHtml += '    document.getElementById("preScript").value = question.pre_script || "";\n';
bodyHtml += '    document.getElementById("validationScript").value = question.validation_script || "";\n';
bodyHtml += '    \n';
bodyHtml += '    // Set text and audio for each language\n';
bodyHtml += '    surveyLanguages.forEach(lang => {\n';
bodyHtml += '        const langId = lang.replace(/\\s+/g, "_");\n';
bodyHtml += '        \n';
bodyHtml += '        const textInput = document.getElementById("text_" + langId);\n';
bodyHtml += '        if (textInput) textInput.value = question.texts[lang] || "";\n';
bodyHtml += '        \n';
bodyHtml += '        const audioInput = document.getElementById("audio_" + langId);\n';
bodyHtml += '        const playBtn = document.getElementById("play_" + langId);\n';
bodyHtml += '        if (audioInput && question.audioFiles && question.audioFiles[lang]) {\n';
bodyHtml += '            audioInput.value = question.audioFiles[lang];\n';
bodyHtml += '            if (playBtn) playBtn.style.display = "inline-block";\n';
bodyHtml += '        } else {\n';
bodyHtml += '            if (audioInput) audioInput.value = "";\n';
bodyHtml += '            if (playBtn) playBtn.style.display = "none";\n';
bodyHtml += '        }\n';
bodyHtml += '    });\n';
bodyHtml += '    \n';
bodyHtml += '    // Setup options if multiple choice\n';
bodyHtml += '    if (question.question_type === "multiple_choice") {\n';
bodyHtml += '        loadOptions(question.options);\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    toggleOptionsSection();\n';
bodyHtml += '    document.getElementById("editModal").style.display = "block";\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function loadOptions(options) {\n';
bodyHtml += '    const container = document.getElementById("optionsList");\n';
bodyHtml += '    container.innerHTML = "";\n';
bodyHtml += '    \n';
bodyHtml += '    options.forEach((opt, idx) => {\n';
bodyHtml += '        const optTexts = typeof opt.option_text_json === "string" ? \n';
bodyHtml += '            JSON.parse(opt.option_text_json) : opt.option_text_json || {};\n';
bodyHtml += '        addOptionWithData(optTexts);\n';
bodyHtml += '    });\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function addOption() {\n';
bodyHtml += '    addOptionWithData({});\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function addOptionWithData(texts) {\n';
bodyHtml += '    const container = document.getElementById("optionsList");\n';
bodyHtml += '    const optionDiv = document.createElement("div");\n';
bodyHtml += '    optionDiv.className = "option-input-group";\n';
bodyHtml += '    \n';
bodyHtml += '    let html = "";\n';
bodyHtml += '    surveyLanguages.forEach(lang => {\n';
bodyHtml += '        html += \'<input type="text" class="form-control option-text" data-lang="\' + lang + \'" placeholder="\' + lang + \' option" value="\' + (texts[lang] || "") + \'">\';\n';
bodyHtml += '    });\n';
bodyHtml += '    html += \'<button type="button" onclick="removeOption(this)" class="btn btn-danger btn-sm">X</button>\';\n';
bodyHtml += '    \n';
bodyHtml += '    optionDiv.innerHTML = html;\n';
bodyHtml += '    container.appendChild(optionDiv);\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function removeOption(button) {\n';
bodyHtml += '    button.parentElement.remove();\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function toggleOptionsSection() {\n';
bodyHtml += '    const type = document.getElementById("questionType").value;\n';
bodyHtml += '    document.getElementById("optionsSection").style.display = \n';
bodyHtml += '        type === "multiple_choice" ? "block" : "none";\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function closeModal() {\n';
bodyHtml += '    document.getElementById("editModal").style.display = "none";\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function saveQuestion() {\n';
bodyHtml += '    const questionId = document.getElementById("questionId").value;\n';
bodyHtml += '    const isNewQuestion = !questionId;\n';
bodyHtml += '    \n';
bodyHtml += '    // Collect texts and audio\n';
bodyHtml += '    const texts = {};\n';
bodyHtml += '    const audioFiles = {};\n';
bodyHtml += '    surveyLanguages.forEach(lang => {\n';
bodyHtml += '        const langId = lang.replace(/\\s+/g, "_");\n';
bodyHtml += '        const value = document.getElementById("text_" + langId).value;\n';
bodyHtml += '        if (value) texts[lang] = value;\n';
bodyHtml += '        \n';
bodyHtml += '        const audioValue = document.getElementById("audio_" + langId).value;\n';
bodyHtml += '        if (audioValue && audioValue.length > 0) {\n';
bodyHtml += '            audioFiles[lang] = audioValue;\n';
bodyHtml += '            console.log("Audio saved for " + lang + ", length: " + audioValue.length);\n';
bodyHtml += '        }\n';
bodyHtml += '    });\n';
bodyHtml += '    \n';
bodyHtml += '    // Collect options if multiple choice\n';
bodyHtml += '    const options = [];\n';
bodyHtml += '    if (document.getElementById("questionType").value === "multiple_choice") {\n';
bodyHtml += '        document.querySelectorAll(".option-input-group").forEach((group, idx) => {\n';
bodyHtml += '            const optionTexts = {};\n';
bodyHtml += '            group.querySelectorAll(".option-text").forEach(input => {\n';
bodyHtml += '                if (input.value) optionTexts[input.dataset.lang] = input.value;\n';
bodyHtml += '            });\n';
bodyHtml += '            options.push({\n';
bodyHtml += '                option_index: idx,\n';
bodyHtml += '                text_json: optionTexts,\n';
bodyHtml += '                audio_json: {}\n';
bodyHtml += '            });\n';
bodyHtml += '        });\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    const data = {\n';
bodyHtml += '        short_name: document.getElementById("shortName").value,\n';
bodyHtml += '        question_text_json: texts,\n';
bodyHtml += '        question_type: document.getElementById("questionType").value,\n';
bodyHtml += '        pre_script: document.getElementById("preScript").value || null,\n';
bodyHtml += '        validation_script: document.getElementById("validationScript").value || null,\n';
bodyHtml += '        audio_files_json: audioFiles,\n';
bodyHtml += '        validation_error_json: {},\n';
bodyHtml += '        options: options\n';
bodyHtml += '    };\n';
bodyHtml += '    \n';
bodyHtml += '    // For new questions, add at the end\n';
bodyHtml += '    if (isNewQuestion) {\n';
bodyHtml += '        data.question_index = questionsData.length;\n';
bodyHtml += '    } else {\n';
bodyHtml += '        const question = questionsData.find(q => q.id === parseInt(questionId));\n';
bodyHtml += '        data.question_index = question.question_index;\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    try {\n';
bodyHtml += '        let url, method;\n';
bodyHtml += '        if (isNewQuestion) {\n';
bodyHtml += '            url = "/api/admin/survey-config/" + surveyId + "/questions";\n';
bodyHtml += '            method = "POST";\n';
bodyHtml += '        } else {\n';
bodyHtml += '            url = "/api/admin/survey-config/" + surveyId + "/questions/" + questionId;\n';
bodyHtml += '            method = "PUT";\n';
bodyHtml += '        }\n';
bodyHtml += '        \n';
bodyHtml += '        const response = await fetch(url, {\n';
bodyHtml += '            method: method,\n';
bodyHtml += '            headers: { "Content-Type": "application/json" },\n';
bodyHtml += '            body: JSON.stringify(data)\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            alert(isNewQuestion ? "Question created successfully" : "Question updated successfully");\n';
bodyHtml += '            location.reload();\n';
bodyHtml += '        } else {\n';
bodyHtml += '            const result = await response.json();\n';
bodyHtml += '            alert("Failed to save: " + result.error);\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        alert("Error: " + error.message);\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += '// Close modal when clicking outside\n';
bodyHtml += 'window.onclick = function(event) {\n';
bodyHtml += '    const modal = document.getElementById("editModal");\n';
bodyHtml += '    if (event.target === modal) {\n';
bodyHtml += '        closeModal();\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += '// Audio recording functionality\n';
bodyHtml += 'let mediaRecorder = null;\n';
bodyHtml += 'let audioChunks = [];\n';
bodyHtml += 'let currentRecordingLang = null;\n';
bodyHtml += '\n';
bodyHtml += '// Convert audio blob to MP3 using lamejs\n';
bodyHtml += 'async function convertToMp3(audioBlob) {\n';
bodyHtml += '    return new Promise(async (resolve, reject) => {\n';
bodyHtml += '        try {\n';
bodyHtml += '            // Create audio context to decode the WebM audio\n';
bodyHtml += '            const audioContext = new (window.AudioContext || window.webkitAudioContext)();\n';
bodyHtml += '            const arrayBuffer = await audioBlob.arrayBuffer();\n';
bodyHtml += '            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);\n';
bodyHtml += '            \n';
bodyHtml += '            // Get audio data\n';
bodyHtml += '            const channels = audioBuffer.numberOfChannels;\n';
bodyHtml += '            const sampleRate = audioBuffer.sampleRate;\n';
bodyHtml += '            const samples = audioBuffer.length;\n';
bodyHtml += '            \n';
bodyHtml += '            // Convert to 16-bit PCM\n';
bodyHtml += '            const leftChannel = audioBuffer.getChannelData(0);\n';
bodyHtml += '            const rightChannel = channels > 1 ? audioBuffer.getChannelData(1) : leftChannel;\n';
bodyHtml += '            \n';
bodyHtml += '            // Convert float samples to 16-bit PCM\n';
bodyHtml += '            const left = new Int16Array(samples);\n';
bodyHtml += '            const right = new Int16Array(samples);\n';
bodyHtml += '            for (let i = 0; i < samples; i++) {\n';
bodyHtml += '                left[i] = Math.max(-32768, Math.min(32767, leftChannel[i] * 32768));\n';
bodyHtml += '                right[i] = Math.max(-32768, Math.min(32767, rightChannel[i] * 32768));\n';
bodyHtml += '            }\n';
bodyHtml += '            \n';
bodyHtml += '            // Create MP3 encoder\n';
bodyHtml += '            const mp3Encoder = new lamejs.Mp3Encoder(channels, sampleRate, 128);\n';
bodyHtml += '            const mp3Data = [];\n';
bodyHtml += '            \n';
bodyHtml += '            // Encode in chunks\n';
bodyHtml += '            const blockSize = 1152;\n';
bodyHtml += '            for (let i = 0; i < samples; i += blockSize) {\n';
bodyHtml += '                const leftChunk = left.subarray(i, Math.min(i + blockSize, samples));\n';
bodyHtml += '                const rightChunk = right.subarray(i, Math.min(i + blockSize, samples));\n';
bodyHtml += '                const mp3buf = mp3Encoder.encodeBuffer(leftChunk, rightChunk);\n';
bodyHtml += '                if (mp3buf.length > 0) {\n';
bodyHtml += '                    mp3Data.push(mp3buf);\n';
bodyHtml += '                }\n';
bodyHtml += '            }\n';
bodyHtml += '            \n';
bodyHtml += '            // Flush encoder\n';
bodyHtml += '            const mp3buf = mp3Encoder.flush();\n';
bodyHtml += '            if (mp3buf.length > 0) {\n';
bodyHtml += '                mp3Data.push(mp3buf);\n';
bodyHtml += '            }\n';
bodyHtml += '            \n';
bodyHtml += '            // Create blob and convert to base64\n';
bodyHtml += '            const mp3Blob = new Blob(mp3Data, { type: "audio/mp3" });\n';
bodyHtml += '            const reader = new FileReader();\n';
bodyHtml += '            reader.onloadend = () => {\n';
bodyHtml += '                resolve(reader.result);\n';
bodyHtml += '            };\n';
bodyHtml += '            reader.onerror = reject;\n';
bodyHtml += '            reader.readAsDataURL(mp3Blob);\n';
bodyHtml += '        } catch (error) {\n';
bodyHtml += '            reject(error);\n';
bodyHtml += '        }\n';
bodyHtml += '    });\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function toggleRecording(langId) {\n';
bodyHtml += '    const recordBtn = document.getElementById("record_" + langId);\n';
bodyHtml += '    const playBtn = document.getElementById("play_" + langId);\n';
bodyHtml += '    \n';
bodyHtml += '    if (mediaRecorder && mediaRecorder.state === "recording") {\n';
bodyHtml += '        // Stop recording\n';
bodyHtml += '        mediaRecorder.stop();\n';
bodyHtml += '        recordBtn.textContent = "üé§ Record";\n';
bodyHtml += '        recordBtn.style.background = "";\n';
bodyHtml += '    } else {\n';
bodyHtml += '        // Start recording\n';
bodyHtml += '        try {\n';
bodyHtml += '            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n';
bodyHtml += '            mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });\n';
bodyHtml += '            audioChunks = [];\n';
bodyHtml += '            currentRecordingLang = langId;\n';
bodyHtml += '            \n';
bodyHtml += '            mediaRecorder.ondataavailable = (event) => {\n';
bodyHtml += '                audioChunks.push(event.data);\n';
bodyHtml += '            };\n';
bodyHtml += '            \n';
bodyHtml += '            mediaRecorder.onstop = async () => {\n';
bodyHtml += '                const audioBlob = new Blob(audioChunks, { type: "audio/webm" });\n';
bodyHtml += '                \n';
bodyHtml += '                // Convert WebM to MP3\n';
bodyHtml += '                try {\n';
bodyHtml += '                    console.log("Converting audio to MP3...");\n';
bodyHtml += '                    const mp3Base64 = await convertToMp3(audioBlob);\n';
bodyHtml += '                    console.log("MP3 conversion successful, length:", mp3Base64.length);\n';
bodyHtml += '                    document.getElementById("audio_" + currentRecordingLang).value = mp3Base64;\n';
bodyHtml += '                    \n';
bodyHtml += '                    // Show play button\n';
bodyHtml += '                    document.getElementById("play_" + currentRecordingLang).style.display = "inline-block";\n';
bodyHtml += '                } catch (error) {\n';
bodyHtml += '                    console.error("Error converting to MP3:", error);\n';
bodyHtml += '                    alert("Error converting audio to MP3: " + error.message);\n';
bodyHtml += '                }\n';
bodyHtml += '                \n';
bodyHtml += '                // Stop all tracks\n';
bodyHtml += '                stream.getTracks().forEach(track => track.stop());\n';
bodyHtml += '            };\n';
bodyHtml += '            \n';
bodyHtml += '            mediaRecorder.start();\n';
bodyHtml += '            recordBtn.textContent = "‚èπ Stop";\n';
bodyHtml += '            recordBtn.style.background = "#e74c3c";\n';
bodyHtml += '        } catch (error) {\n';
bodyHtml += '            alert("Error accessing microphone: " + error.message);\n';
bodyHtml += '        }\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function playAudio(langId) {\n';
bodyHtml += '    const audioData = document.getElementById("audio_" + langId).value;\n';
bodyHtml += '    if (audioData) {\n';
bodyHtml += '        const audio = new Audio(audioData);\n';
bodyHtml += '        audio.play();\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += '// Initialize on load\n';
bodyHtml += 'document.addEventListener("DOMContentLoaded", function() {\n';
bodyHtml += '    initializeDragAndDrop();\n';
bodyHtml += '});\n';
bodyHtml += '</script>\n';

var body = bodyHtml;
%>
<%- include('../layouts/main', { title: 'Edit Survey: ' + survey.name, username: username, body: body }) %>