<%
// Prepare the questions data
const questionsData = questions.map(q => {
    const texts = typeof q.question_text_json === 'string' ? JSON.parse(q.question_text_json) : q.question_text_json || {};
    const audioFiles = typeof q.audio_files_json === 'string' ? JSON.parse(q.audio_files_json) : q.audio_files_json || {};
    const validationError = typeof q.validation_error_json === 'string' ? JSON.parse(q.validation_error_json) : q.validation_error_json || {};
    return {
        id: q.id,
        question_index: q.question_index,
        short_name: q.short_name,
        question_type: q.question_type,
        section_id: q.section_id,
        texts: texts,
        audioFiles: audioFiles,
        pre_script: q.pre_script,
        validation_script: q.validation_script,
        validation_error: validationError,
        min_selections: q.min_selections,
        max_selections: q.max_selections,
        options: q.options || []
    };
});

// Parse survey languages
const surveyLanguages = typeof survey.languages === 'string' ? JSON.parse(survey.languages) : survey.languages || ['en'];

// Sections are passed as a separate variable from the route
// If not available, fall back to empty array
const sectionsData = typeof sections !== 'undefined' ? sections : [];

// Parse eligibility message
const eligibilityMessage = typeof survey.eligibility_message_json === 'string' ? 
    JSON.parse(survey.eligibility_message_json) : survey.eligibility_message_json || {};

// Build the body HTML
let bodyHtml = '<link rel="stylesheet" href="/css/survey-editor.css">\n';
bodyHtml += '<script src="/js/lamejs/lame.min.js"></script>\n';
bodyHtml += '<h2>Survey Editor: ' + survey.name + ' (v' + survey.version + ')</h2>\n';

// Survey info card
bodyHtml += '<div class="card">\n';
bodyHtml += '    <h3>Survey Information</h3>\n';
bodyHtml += '    <p><strong>Name:</strong> ' + survey.name + '</p>\n';
bodyHtml += '    <p><strong>Version:</strong> ' + survey.version + '</p>\n';
bodyHtml += '    <p><strong>Description:</strong> ' + (survey.description || 'No description') + '</p>\n';
bodyHtml += '    <p><strong>Status:</strong> ' + (survey.is_active ? 'Active' : 'Inactive') + '</p>\n';
bodyHtml += '    <p><strong>Languages:</strong> ' + surveyLanguages.join(', ') + '</p>\n';
bodyHtml += '</div>\n';

// Fingerprint Configuration card
bodyHtml += '<div class="card">\n';
bodyHtml += '    <h3>Fingerprint Configuration</h3>\n';
bodyHtml += '    <div style="margin-bottom: 1rem;">\n';
bodyHtml += '        <label style="display: flex; align-items: center; gap: 0.5rem;">\n';
bodyHtml += '            <input type="checkbox" id="fingerprintEnabled" ' + (survey.fingerprint_enabled ? 'checked' : '') + '>\n';
bodyHtml += '            <span>Enable Fingerprint Screening</span>\n';
bodyHtml += '        </label>\n';
bodyHtml += '        <small style="color: #666; margin-left: 1.5rem;">Requires fingerprint capture to prevent duplicate enrollment</small>\n';
bodyHtml += '    </div>\n';
bodyHtml += '    <div style="margin-bottom: 1rem;">\n';
bodyHtml += '        <label style="display: block; margin-bottom: 0.25rem;">Re-enrollment Period (days)</label>\n';
bodyHtml += '        <input type="number" id="reEnrollmentDays" value="' + (survey.re_enrollment_days || 90) + '" min="1" max="365" style="padding: 0.5rem; width: 150px;">\n';
bodyHtml += '        <small style="display: block; color: #666; margin-top: 0.25rem;">Number of days before a participant can re-enroll</small>\n';
bodyHtml += '    </div>\n';
bodyHtml += '    <button onclick="saveFingerprintSettings()" class="btn">Save Fingerprint Settings</button>\n';
bodyHtml += '</div>\n';

// System Messages card
bodyHtml += '<div class="card">\n';
bodyHtml += '    <h3>System Messages</h3>\n';
bodyHtml += '    <p style="color: #666; margin-bottom: 1rem;">Manage system messages shown during the survey flow</p>\n';
bodyHtml += '    <div id="systemMessagesContainer">Loading messages...</div>\n';
bodyHtml += '</div>\n';

// Language management card
bodyHtml += '<div class="card">\n';
bodyHtml += '    <h3>Language Management</h3>\n';
bodyHtml += '    <div style="margin-bottom: 1rem;">\n';
bodyHtml += '        <strong>Current Languages:</strong>\n';
bodyHtml += '        <div id="languagesList" style="margin: 0.5rem 0;">\n';
surveyLanguages.forEach(lang => {
    bodyHtml += '            <div class="language-item" style="display: inline-block; margin: 0.25rem; padding: 0.5rem; background: #f0f0f0; border-radius: 4px;">\n';
    bodyHtml += '                ' + lang + '\n';
    if (surveyLanguages.length > 1) {  // Don't allow removing the last language
        bodyHtml += '                <button onclick="removeLanguage(\'' + lang + '\')" style="margin-left: 0.5rem; background: #e74c3c; color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer;">√ó</button>\n';
    }
    bodyHtml += '            </div>\n';
});
bodyHtml += '        </div>\n';
bodyHtml += '    </div>\n';
bodyHtml += '    <div style="display: flex; gap: 0.5rem; align-items: center;">\n';
bodyHtml += '        <select id="newLanguageSelect" style="padding: 0.5rem;" onchange="handleLanguageSelectChange()">\n';
bodyHtml += '            <option value="">Select a language...</option>\n';
bodyHtml += '            <option value="English">English</option>\n';
bodyHtml += '            <option value="Swahili">Swahili</option>\n';
bodyHtml += '            <option value="Spanish">Spanish</option>\n';
bodyHtml += '            <option value="French">French</option>\n';
bodyHtml += '            <option value="Portuguese">Portuguese</option>\n';
bodyHtml += '            <option value="Arabic">Arabic</option>\n';
bodyHtml += '            <option value="Chinese">Chinese</option>\n';
bodyHtml += '            <option value="Hindi">Hindi</option>\n';
bodyHtml += '            <option value="Other">Other...</option>\n';
bodyHtml += '        </select>\n';
bodyHtml += '        <input type="text" id="customLanguageInput" placeholder="Enter custom language" style="padding: 0.5rem; display: none;">\n';
bodyHtml += '        <button onclick="addLanguage()" class="btn">Add Language</button>\n';
bodyHtml += '    </div>\n';
bodyHtml += '</div>\n';

// Eligibility settings card
bodyHtml += '<div class="card">\n';
bodyHtml += '    <h3>Eligibility Settings</h3>\n';
bodyHtml += '    <div style="margin-bottom: 1rem;">\n';
bodyHtml += '        <label><strong>Eligibility Script (JEXL Expression):</strong></label>\n';
bodyHtml += '        <textarea id="eligibilityScript" style="width: 100%; min-height: 60px; padding: 0.5rem; font-family: monospace;">' + (survey.eligibility_script || '') + '</textarea>\n';
bodyHtml += '        <small style="color: #666;">This script runs after the eligibility section. Example: consent == "1" && age >= 18 && age <= 65</small>\n';
bodyHtml += '    </div>\n';
bodyHtml += '    <div style="margin-bottom: 1rem;">\n';
bodyHtml += '        <label><strong>Ineligibility Messages:</strong></label>\n';
surveyLanguages.forEach(lang => {
    bodyHtml += '        <div style="margin-bottom: 0.5rem;">\n';
    bodyHtml += '            <label>' + lang + ':</label>\n';
    bodyHtml += '            <input type="text" class="eligibility-message" data-lang="' + lang + '" value="' + (eligibilityMessage[lang] || '') + '" style="width: 100%; padding: 0.5rem;">\n';
    bodyHtml += '        </div>\n';
});
bodyHtml += '    </div>\n';
bodyHtml += '    <button onclick="saveEligibilitySettings()" class="btn">Save Eligibility Settings</button>\n';
bodyHtml += '</div>\n';

// Questions by sections
bodyHtml += '<div class="card">\n';
bodyHtml += '    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">\n';
bodyHtml += '        <h3>Questions (' + questions.length + ')</h3>\n';
bodyHtml += '        <div>\n';
bodyHtml += '            <button onclick="newQuestion()" class="btn" style="margin-right: 0.5rem;">New Question</button>\n';
bodyHtml += '            <button onclick="saveQuestionOrder()" class="btn">Save Order</button>\n';
bodyHtml += '        </div>\n';
bodyHtml += '    </div>\n';

// Display questions grouped by section
if (sectionsData.length > 0) {
    sectionsData.forEach(section => {
        bodyHtml += '    <div class="section-group" style="margin-bottom: 2rem;">\n';
        bodyHtml += '        <h4 style="background: #f0f0f0; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">';
        bodyHtml += section.name + ' (' + section.section_type + ')';
        if (section.section_type === 'eligibility') {
            bodyHtml += ' <span style="color: #e74c3c; font-size: 0.9rem;">‚ö†Ô∏è Determines eligibility</span>';
        }
        bodyHtml += '</h4>\n';
        bodyHtml += '        <div class="section-questions" data-section-id="' + section.id + '">\n';
        
        // Filter questions that belong to this section
        const sectionQuestions = questionsData.filter(q => q.section_id === section.id);
        if (sectionQuestions.length === 0) {
            bodyHtml += '            <p style="text-align: center; color: #999; padding: 1rem;">No questions in this section</p>\n';
        } else {
            sectionQuestions.forEach(qData => {
                addQuestionHtml(qData);
            });
        }
        
        bodyHtml += '        </div>\n';
        bodyHtml += '    </div>\n';
    });
} else {
    bodyHtml += '    <div id="questionsList">\n';
    // Fallback to showing all questions if no sections
    questionsData.forEach((q, idx) => {
        addQuestionHtml(q);
    });
    bodyHtml += '    </div>\n';
}

function addQuestionHtml(q) {
    bodyHtml += '        <div class="question-item" draggable="true" data-question-id="' + q.id + '" data-question-index="' + q.question_index + '">\n';
    bodyHtml += '            <div class="question-header">\n';
    bodyHtml += '                <div style="flex: 1;">\n';
    bodyHtml += '                    <span class="drag-handle">‚â°</span>\n';
    bodyHtml += '                    <span class="question-number">Q' + (q.question_index + 1) + '</span>\n';
    bodyHtml += '                    <strong>' + q.short_name + '</strong>\n';
    bodyHtml += '                    <span class="question-type-badge">' + q.question_type.replace('_', ' ') + '</span>\n';
    bodyHtml += '                </div>\n';
    bodyHtml += '                <button onclick="editQuestion(' + q.id + ')" class="btn btn-sm">Edit</button>\n';
    bodyHtml += '            </div>\n';
    bodyHtml += '            <div style="margin-left: 2rem;">\n';
    // Get the first language text (prioritize English if available)
    const primaryText = q.texts.English || q.texts[Object.keys(q.texts)[0]] || 'No text';
    bodyHtml += '                <p style="margin: 0.5rem 0;">' + primaryText + '</p>\n';
    
    // Show other language texts
    Object.keys(q.texts).filter(lang => lang.toLowerCase() !== 'english').forEach(lang => {
        bodyHtml += '                <p style="margin: 0.25rem 0; color: #666; font-size: 0.9rem;">\n';
        bodyHtml += '                    <strong>' + lang + ':</strong> ' + q.texts[lang] + '\n';
        bodyHtml += '                </p>\n';
    });
    
    // Show options for multiple choice
    if (q.question_type === 'multiple_choice' && q.options && q.options.length > 0) {
        bodyHtml += '                <div class="options-list">\n';
        q.options.forEach((opt, optIdx) => {
            const optTexts = typeof opt.option_text_json === 'string' ? 
                JSON.parse(opt.option_text_json) : opt.option_text_json || {};
            bodyHtml += '                    <div class="option-item">\n';
            bodyHtml += '                        <span class="option-index">' + optIdx + '</span>\n';
            const optPrimaryText = optTexts.English || optTexts[Object.keys(optTexts)[0]] || 'No text';
            bodyHtml += '                        ' + optPrimaryText + '\n';
            bodyHtml += '                    </div>\n';
            });
        bodyHtml += '                </div>\n';
    }
    
    // Show skip logic and validation
    bodyHtml += '                <div>\n';
    if (q.pre_script) {
        bodyHtml += '                    <span class="skip-logic-tag">Skip Logic: ' + q.pre_script + '</span>\n';
    }
    if (q.validation_script) {
        bodyHtml += '                    <span class="validation-tag">Validation: ' + q.validation_script + '</span>\n';
    }
    bodyHtml += '                </div>\n';
    bodyHtml += '            </div>\n';
    bodyHtml += '        </div>\n';
}

bodyHtml += '</div>\n';

// Add edit modal
bodyHtml += '<div id="editModal" class="modal">\n';
bodyHtml += '    <div class="modal-content">\n';
bodyHtml += '        <div class="modal-header">\n';
bodyHtml += '            <h3 id="modalTitle">Edit Question</h3>\n';
bodyHtml += '            <span class="close" onclick="closeModal()">&times;</span>\n';
bodyHtml += '        </div>\n';
bodyHtml += '        <div class="modal-body">\n';
bodyHtml += '            <form id="editForm">\n';
bodyHtml += '                <input type="hidden" id="questionId">\n';
bodyHtml += '                \n';
bodyHtml += '                <div class="form-group">\n';
bodyHtml += '                    <label>Section</label>\n';
bodyHtml += '                    <select id="sectionId" class="form-control">\n';
sectionsData.forEach(section => {
    bodyHtml += '                        <option value="' + section.id + '">' + section.name + ' (' + section.section_type + ')</option>\n';
});
bodyHtml += '                    </select>\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div class="form-group">\n';
bodyHtml += '                    <label>Short Name</label>\n';
bodyHtml += '                    <input type="text" id="shortName" class="form-control" pattern="^[a-zA-Z0-9_]+$" required>\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div class="form-group">\n';
bodyHtml += '                    <label>Question Type</label>\n';
bodyHtml += '                    <select id="questionType" class="form-control" onchange="toggleOptionsSection()">\n';
bodyHtml += '                        <option value="multiple_choice">Multiple Choice</option>\n';
bodyHtml += '                        <option value="multi_select">Multi-Select (Check All That Apply)</option>\n';
bodyHtml += '                        <option value="numeric">Numeric</option>\n';
bodyHtml += '                        <option value="text">Text</option>\n';
bodyHtml += '                    </select>\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div id="languageTexts">\n';
bodyHtml += '                    <label>Question Text</label>\n';
// Add input for each language
surveyLanguages.forEach(lang => {
    const langId = lang.replace(/\s+/g, '_');
    bodyHtml += '                    <div class="form-group">\n';
    bodyHtml += '                        <div style="display: flex; gap: 0.5rem; align-items: center;">\n';
    bodyHtml += '                            <input type="text" id="text_' + langId + '" class="form-control" placeholder="' + lang + ' text" ' + (lang.toLowerCase() === 'english' ? 'required' : '') + ' style="flex: 1;">\n';
    bodyHtml += '                            <button type="button" id="record_' + langId + '" onclick="toggleRecording(\'' + langId + '\')" class="btn btn-sm" style="width: 100px;">üé§ Record</button>\n';
    bodyHtml += '                            <button type="button" id="play_' + langId + '" onclick="playAudio(\'' + langId + '\')" class="btn btn-sm" style="display: none;">‚ñ∂Ô∏è Play</button>\n';
    bodyHtml += '                        </div>\n';
    bodyHtml += '                        <input type="hidden" id="audio_' + langId + '">\n';
    bodyHtml += '                    </div>\n';
});
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div id="optionsSection" style="display: none;">\n';
bodyHtml += '                    <label>Options</label>\n';
bodyHtml += '                    <div id="optionsList"></div>\n';
bodyHtml += '                    <button type="button" onclick="addOption()" class="btn btn-sm">Add Option</button>\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div id="multiSelectFields" style="display: none;">\n';
bodyHtml += '                    <div class="form-row" style="display: flex; gap: 1rem; margin-top: 1rem;">\n';
bodyHtml += '                        <div class="form-group" style="flex: 1;">\n';
bodyHtml += '                            <label>Minimum Selections</label>\n';
bodyHtml += '                            <input type="number" id="minSelections" class="form-control" min="0" placeholder="Leave empty for no minimum">\n';
bodyHtml += '                            <small style="color: #666;">Minimum number of options that must be selected</small>\n';
bodyHtml += '                        </div>\n';
bodyHtml += '                        <div class="form-group" style="flex: 1;">\n';
bodyHtml += '                            <label>Maximum Selections</label>\n';
bodyHtml += '                            <input type="number" id="maxSelections" class="form-control" min="1" placeholder="Leave empty for unlimited">\n';
bodyHtml += '                            <small style="color: #666;">Maximum number of options that can be selected</small>\n';
bodyHtml += '                        </div>\n';
bodyHtml += '                    </div>\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div class="form-group">\n';
bodyHtml += '                    <label>Skip Logic (JEXL expression)</label>\n';
bodyHtml += '                    <input type="text" id="preScript" class="form-control" placeholder="e.g., age >= 18">\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '                <div class="form-group">\n';
bodyHtml += '                    <label>Validation Script</label>\n';
bodyHtml += '                    <input type="text" id="validationScript" class="form-control" placeholder="e.g., value >= 0 && value <= 100">\n';
bodyHtml += '                </div>\n';
bodyHtml += '                \n';
bodyHtml += '            </form>\n';
bodyHtml += '        </div>\n';
bodyHtml += '        <div class="modal-footer">\n';
bodyHtml += '            <button onclick="saveQuestion()" class="btn">Save</button>\n';
bodyHtml += '            <button onclick="closeModal()" class="btn btn-danger">Cancel</button>\n';
bodyHtml += '        </div>\n';
bodyHtml += '    </div>\n';
bodyHtml += '</div>\n';

// Add CSS styles
bodyHtml += '<style>\n';
bodyHtml += '.btn-sm { padding: 0.25rem 0.5rem; font-size: 0.9rem; }\n';
bodyHtml += '.question-item { background: #f8f8f8; padding: 1rem; margin-bottom: 0.5rem; border-radius: 4px; cursor: move; }\n';
bodyHtml += '.question-item.dragging { opacity: 0.5; }\n';
bodyHtml += '.question-item.drag-over { border-top: 3px solid #3498db; }\n';
bodyHtml += '.section-questions { min-height: 50px; padding: 0.5rem; border: 2px dashed transparent; transition: all 0.3s; }\n';
bodyHtml += '.section-questions.drag-over { border-color: #3498db; background: #ecf6ff; }\n';
bodyHtml += '.question-header { display: flex; justify-content: space-between; align-items: center; }\n';
bodyHtml += '.drag-handle { color: #666; margin-right: 0.5rem; font-size: 1.2rem; }\n';
bodyHtml += '.question-number { background: #3498db; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; margin-right: 0.5rem; }\n';
bodyHtml += '.question-type-badge { background: #95a5a6; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; margin-left: 0.5rem; font-size: 0.8rem; }\n';
bodyHtml += '.options-list { margin: 0.5rem 0; padding-left: 1rem; }\n';
bodyHtml += '.option-item { padding: 0.25rem 0; }\n';
bodyHtml += '.option-index { background: #ecf0f1; padding: 0.2rem 0.4rem; border-radius: 3px; margin-right: 0.5rem; }\n';
bodyHtml += '.skip-logic-tag { background: #f39c12; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; margin-right: 0.5rem; font-size: 0.8rem; }\n';
bodyHtml += '.validation-tag { background: #e74c3c; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; }\n';
bodyHtml += '.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }\n';
bodyHtml += '.modal-content { background-color: #fefefe; margin: 5% auto; width: 80%; max-width: 600px; border-radius: 8px; }\n';
bodyHtml += '.modal-header { padding: 1rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }\n';
bodyHtml += '.modal-body { padding: 1rem; max-height: 60vh; overflow-y: auto; }\n';
bodyHtml += '.modal-footer { padding: 1rem; border-top: 1px solid #ddd; display: flex; gap: 0.5rem; justify-content: flex-end; }\n';
bodyHtml += '.close { font-size: 28px; font-weight: bold; cursor: pointer; }\n';
bodyHtml += '.close:hover { color: #000; }\n';
bodyHtml += '.form-group { margin-bottom: 1rem; }\n';
bodyHtml += '.form-group label { display: block; margin-bottom: 0.25rem; font-weight: bold; }\n';
bodyHtml += '.form-control { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }\n';
bodyHtml += '.option-input-group { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }\n';
bodyHtml += '.option-input-group input { flex: 1; }\n';
bodyHtml += '</style>\n';

// Add JavaScript
bodyHtml += '<script>\n';
bodyHtml += 'const surveyId = ' + survey.id + ';\n';
bodyHtml += 'const surveyLanguages = ' + JSON.stringify(surveyLanguages) + ';\n';
bodyHtml += 'const sectionsData = ' + JSON.stringify(sectionsData) + ';\n';
bodyHtml += 'let questionOrder = [' + questions.map(q => q.id).join(', ') + '];\n';
bodyHtml += 'let draggedElement = null;\n';
bodyHtml += 'let questionsData = ' + JSON.stringify(questionsData) + ';\n';
bodyHtml += 'let systemMessages = {};\n';
bodyHtml += 'let messageAudioRecorders = {};\n';
bodyHtml += '\n';
bodyHtml += '// Save eligibility settings\n';
bodyHtml += 'async function saveEligibilitySettings() {\n';
bodyHtml += '    const eligibilityScript = document.getElementById("eligibilityScript").value;\n';
bodyHtml += '    const eligibilityMessages = {};\n';
bodyHtml += '    document.querySelectorAll(".eligibility-message").forEach(input => {\n';
bodyHtml += '        if (input.value) eligibilityMessages[input.dataset.lang] = input.value;\n';
bodyHtml += '    });\n';
bodyHtml += '    \n';
bodyHtml += '    try {\n';
bodyHtml += '        const response = await fetch("/api/admin/survey-config/" + surveyId, {\n';
bodyHtml += '            method: "PUT",\n';
bodyHtml += '            headers: { "Content-Type": "application/json" },\n';
bodyHtml += '            body: JSON.stringify({\n';
bodyHtml += '                eligibility_script: eligibilityScript,\n';
bodyHtml += '                eligibility_message_json: eligibilityMessages\n';
bodyHtml += '            })\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            alert("Eligibility settings saved successfully");\n';
bodyHtml += '        } else {\n';
bodyHtml += '            const result = await response.json();\n';
bodyHtml += '            alert("Failed to save: " + result.error);\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        alert("Error: " + error.message);\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';

// Language management functions
bodyHtml += 'function handleLanguageSelectChange() {\n';
bodyHtml += '    const select = document.getElementById("newLanguageSelect");\n';
bodyHtml += '    const customInput = document.getElementById("customLanguageInput");\n';
bodyHtml += '    if (select.value === "Other") {\n';
bodyHtml += '        customInput.style.display = "block";\n';
bodyHtml += '    } else {\n';
bodyHtml += '        customInput.style.display = "none";\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function saveFingerprintSettings() {\n';
bodyHtml += '    const fingerprintEnabled = document.getElementById("fingerprintEnabled").checked;\n';
bodyHtml += '    const reEnrollmentDays = parseInt(document.getElementById("reEnrollmentDays").value);\n';
bodyHtml += '    \n';
bodyHtml += '    if (isNaN(reEnrollmentDays) || reEnrollmentDays < 1 || reEnrollmentDays > 365) {\n';
bodyHtml += '        alert("Re-enrollment days must be between 1 and 365");\n';
bodyHtml += '        return;\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    try {\n';
bodyHtml += '        const response = await fetch("/api/admin/survey-config/" + surveyId, {\n';
bodyHtml += '            method: "PUT",\n';
bodyHtml += '            credentials: "same-origin",\n';
bodyHtml += '            headers: { "Content-Type": "application/json" },\n';
bodyHtml += '            body: JSON.stringify({\n';
bodyHtml += '                fingerprint_enabled: fingerprintEnabled ? 1 : 0,\n';
bodyHtml += '                re_enrollment_days: reEnrollmentDays,\n';
bodyHtml += '                create_version: false\n';
bodyHtml += '            })\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            alert("Fingerprint settings saved successfully");\n';
bodyHtml += '        } else {\n';
bodyHtml += '            const error = await response.json();\n';
bodyHtml += '            alert("Failed to save fingerprint settings: " + (error.error || "Unknown error"));\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        console.error("Error saving fingerprint settings:", error);\n';
bodyHtml += '        alert("Error saving fingerprint settings: " + error.message);\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += '// Load and display system messages\n';
bodyHtml += 'async function loadSystemMessages() {\n';
bodyHtml += '    try {\n';
bodyHtml += '        const response = await fetch("/api/admin/survey-config/" + surveyId + "/messages", {\n';
bodyHtml += '            credentials: "same-origin"\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            const messages = await response.json();\n';
bodyHtml += '            messages.forEach(msg => {\n';
bodyHtml += '                // Normalize the message structure\n';
bodyHtml += '                systemMessages[msg.message_key] = {\n';
bodyHtml += '                    ...msg,\n';
bodyHtml += '                    text: msg.message_text_json || {},\n';
bodyHtml += '                    audio: msg.audio_files_json || {}\n';
bodyHtml += '                };\n';
bodyHtml += '            });\n';
bodyHtml += '            displaySystemMessages();\n';
bodyHtml += '        } else {\n';
bodyHtml += '            console.error("Failed to load messages");\n';
bodyHtml += '            displaySystemMessages();\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        console.error("Error loading messages:", error);\n';
bodyHtml += '        displaySystemMessages();\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function displaySystemMessages() {\n';
bodyHtml += '    const container = document.getElementById("systemMessagesContainer");\n';
bodyHtml += '    let html = "";\n';
bodyHtml += '    \n';
bodyHtml += '    // Define standard messages\n';
bodyHtml += '    const standardMessages = [\n';
bodyHtml += '        { key: "staff_validation", title: "Staff Validation Message", description: "Shown when staff needs to validate completion" },\n';
bodyHtml += '        { key: "payment_confirmation", title: "Payment Confirmation Message", description: "Shown on the payment confirmation screen before participant receives payment" }\n';
bodyHtml += '    ];\n';
bodyHtml += '    \n';
bodyHtml += '    standardMessages.forEach(msgDef => {\n';
bodyHtml += '        const msg = systemMessages[msgDef.key] || { message_key: msgDef.key, text: {}, audio: {} };\n';
bodyHtml += '        \n';
bodyHtml += '        html += `<div class="message-section" style="margin-bottom: 2rem; padding: 1rem; background: #f9f9f9; border-radius: 8px;">`;\n';
bodyHtml += '        html += `<h4>${msgDef.title}</h4>`;\n';
bodyHtml += '        html += `<p style="color: #666; font-size: 0.9rem;">${msgDef.description}</p>`;\n';
bodyHtml += '        \n';
bodyHtml += '        const languages = ' + JSON.stringify(surveyLanguages) + ';\n';
bodyHtml += '        languages.forEach(lang => {\n';
bodyHtml += '            const langId = lang.replace(/\\s+/g, "_");\n';
bodyHtml += '            const messageText = msg.text[lang] || "";\n';
bodyHtml += '            const hasAudio = msg.audio && msg.audio[lang];\n';
bodyHtml += '            \n';
bodyHtml += '            html += `<div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 4px;">`;\n';
bodyHtml += '            html += `<label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">${lang}:</label>`;\n';
bodyHtml += '            html += `<textarea id="msg_${msgDef.key}_${langId}" data-key="${msgDef.key}" data-lang="${lang}" rows="2" style="width: 100%; padding: 0.5rem;" placeholder="Enter ${lang.toLowerCase()} message...">${messageText}</textarea>`;\n';
bodyHtml += '            \n';
bodyHtml += '            // Audio controls\n';
bodyHtml += '            html += `<div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">`;\n';
bodyHtml += '            html += `<button onclick="startMessageRecording(\'${msgDef.key}\', \'${lang}\')" id="record_${msgDef.key}_${langId}" class="btn btn-sm" style="background: #e74c3c;">üé§ Record Audio</button>`;\n';
bodyHtml += '            html += `<button onclick="stopMessageRecording(\'${msgDef.key}\', \'${lang}\')" id="stop_${msgDef.key}_${langId}" class="btn btn-sm" style="display: none; background: #95a5a6;">‚èπ Stop</button>`;\n';
bodyHtml += '            if (hasAudio) {\n';
bodyHtml += '                html += `<button onclick="playMessageAudio(\'${msgDef.key}\', \'${lang}\')" class="btn btn-sm" style="background: #3498db;">‚ñ∂ Play</button>`;\n';
bodyHtml += '                html += `<button onclick="deleteMessageAudio(\'${msgDef.key}\', \'${lang}\')" class="btn btn-sm" style="background: #e67e22;">üóë Delete Audio</button>`;\n';
bodyHtml += '            }\n';
bodyHtml += '            html += `<audio id="audio_${msgDef.key}_${langId}" style="display: none;"></audio>`;\n';
bodyHtml += '            html += `</div>`;\n';
bodyHtml += '            \n';
bodyHtml += '            html += `</div>`;\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        html += `<button onclick="saveSystemMessage(\'${msgDef.key}\')" class="btn" style="background: #27ae60;">Save ${msgDef.title}</button>`;\n';
bodyHtml += '        html += `</div>`;\n';
bodyHtml += '    });\n';
bodyHtml += '    \n';
bodyHtml += '    container.innerHTML = html;\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function saveSystemMessage(messageKey) {\n';
bodyHtml += '    const textData = {};\n';
bodyHtml += '    const audioData = systemMessages[messageKey]?.audio || {};\n';
bodyHtml += '    \n';
bodyHtml += '    // Collect text for all languages\n';
bodyHtml += '    document.querySelectorAll(`textarea[data-key="${messageKey}"]`).forEach(textarea => {\n';
bodyHtml += '        const lang = textarea.dataset.lang;\n';
bodyHtml += '        const value = textarea.value.trim();\n';
bodyHtml += '        if (value) {\n';
bodyHtml += '            textData[lang] = value;\n';
bodyHtml += '        }\n';
bodyHtml += '    });\n';
bodyHtml += '    \n';
bodyHtml += '    try {\n';
bodyHtml += '        const response = await fetch(`/api/admin/survey-config/${surveyId}/messages/${messageKey}`, {\n';
bodyHtml += '            method: "PUT",\n';
bodyHtml += '            credentials: "same-origin",\n';
bodyHtml += '            headers: { "Content-Type": "application/json" },\n';
bodyHtml += '            body: JSON.stringify({\n';
bodyHtml += '                message_text_json: textData,\n';
bodyHtml += '                audio_files_json: audioData,\n';
bodyHtml += '                message_type: "system"\n';
bodyHtml += '            })\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            const updatedMessage = await response.json();\n';
bodyHtml += '            systemMessages[messageKey] = {\n';
bodyHtml += '                ...updatedMessage,\n';
bodyHtml += '                text: updatedMessage.message_text_json || {},\n';
bodyHtml += '                audio: updatedMessage.audio_files_json || {}\n';
bodyHtml += '            };\n';
bodyHtml += '            alert("Message saved successfully");\n';
bodyHtml += '        } else {\n';
bodyHtml += '            const error = await response.json();\n';
bodyHtml += '            alert("Failed to save message: " + (error.error || "Unknown error"));\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        console.error("Error saving message:", error);\n';
bodyHtml += '        alert("Error saving message: " + error.message);\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += '// System message audio recording variables\n';
bodyHtml += 'let messageMediaRecorder = null;\n';
bodyHtml += 'let messageAudioChunks = [];\n';
bodyHtml += 'let currentMessageRecording = null;\n';
bodyHtml += '\n';
bodyHtml += 'async function startMessageRecording(messageKey, language) {\n';
bodyHtml += '    const langId = language.replace(/\\s+/g, "_");\n';
bodyHtml += '    const recordBtn = document.getElementById(`record_${messageKey}_${langId}`);\n';
bodyHtml += '    const stopBtn = document.getElementById(`stop_${messageKey}_${langId}`);\n';
bodyHtml += '    \n';
bodyHtml += '    try {\n';
bodyHtml += '        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n';
bodyHtml += '        messageMediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });\n';
bodyHtml += '        messageAudioChunks = [];\n';
bodyHtml += '        currentMessageRecording = { messageKey, language };\n';
bodyHtml += '        \n';
bodyHtml += '        messageMediaRecorder.ondataavailable = (event) => {\n';
bodyHtml += '            messageAudioChunks.push(event.data);\n';
bodyHtml += '        };\n';
bodyHtml += '        \n';
bodyHtml += '        messageMediaRecorder.onstop = async () => {\n';
bodyHtml += '            const audioBlob = new Blob(messageAudioChunks, { type: "audio/webm" });\n';
bodyHtml += '            \n';
bodyHtml += '            // Convert WebM to MP3\n';
bodyHtml += '            try {\n';
bodyHtml += '                console.log("Converting message audio to MP3...");\n';
bodyHtml += '                const mp3Base64 = await convertToMp3(audioBlob);\n';
bodyHtml += '                console.log("Message MP3 conversion successful, length:", mp3Base64.length);\n';
bodyHtml += '                \n';
bodyHtml += '                // Update the audio data\n';
bodyHtml += '                if (!systemMessages[currentMessageRecording.messageKey]) {\n';
bodyHtml += '                    systemMessages[currentMessageRecording.messageKey] = { message_key: currentMessageRecording.messageKey, text: {}, audio: {} };\n';
bodyHtml += '                }\n';
bodyHtml += '                if (!systemMessages[currentMessageRecording.messageKey].audio) {\n';
bodyHtml += '                    systemMessages[currentMessageRecording.messageKey].audio = {};\n';
bodyHtml += '                }\n';
bodyHtml += '                systemMessages[currentMessageRecording.messageKey].audio[currentMessageRecording.language] = mp3Base64;\n';
bodyHtml += '                \n';
bodyHtml += '                // Refresh the display to show play button\n';
bodyHtml += '                displaySystemMessages();\n';
bodyHtml += '            } catch (error) {\n';
bodyHtml += '                console.error("Error converting message audio to MP3:", error);\n';
bodyHtml += '                alert("Error converting audio to MP3: " + error.message);\n';
bodyHtml += '            }\n';
bodyHtml += '            \n';
bodyHtml += '            // Stop all tracks\n';
bodyHtml += '            stream.getTracks().forEach(track => track.stop());\n';
bodyHtml += '        };\n';
bodyHtml += '        \n';
bodyHtml += '        messageMediaRecorder.start();\n';
bodyHtml += '        recordBtn.style.display = "none";\n';
bodyHtml += '        stopBtn.style.display = "inline-block";\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        console.error("Error starting recording:", error);\n';
bodyHtml += '        alert("Failed to start recording: " + error.message);\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function stopMessageRecording(messageKey, language) {\n';
bodyHtml += '    const langId = language.replace(/\\s+/g, "_");\n';
bodyHtml += '    const recordBtn = document.getElementById(`record_${messageKey}_${langId}`);\n';
bodyHtml += '    const stopBtn = document.getElementById(`stop_${messageKey}_${langId}`);\n';
bodyHtml += '    \n';
bodyHtml += '    if (messageMediaRecorder && messageMediaRecorder.state === "recording") {\n';
bodyHtml += '        messageMediaRecorder.stop();\n';
bodyHtml += '        recordBtn.style.display = "inline-block";\n';
bodyHtml += '        stopBtn.style.display = "none";\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function playMessageAudio(messageKey, language) {\n';
bodyHtml += '    const langId = language.replace(/\\s+/g, "_");\n';
bodyHtml += '    const audioElement = document.getElementById(`audio_${messageKey}_${langId}`);\n';
bodyHtml += '    const audioData = systemMessages[messageKey]?.audio?.[language];\n';
bodyHtml += '    \n';
bodyHtml += '    if (audioData && audioElement) {\n';
bodyHtml += '        audioElement.src = audioData;\n';
bodyHtml += '        audioElement.play();\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function deleteMessageAudio(messageKey, language) {\n';
bodyHtml += '    if (confirm(`Delete ${language} audio for this message?`)) {\n';
bodyHtml += '        if (systemMessages[messageKey]?.audio) {\n';
bodyHtml += '            delete systemMessages[messageKey].audio[language];\n';
bodyHtml += '            displaySystemMessages();\n';
bodyHtml += '        }\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function addLanguage() {\n';
bodyHtml += '    const select = document.getElementById("newLanguageSelect");\n';
bodyHtml += '    const customInput = document.getElementById("customLanguageInput");\n';
bodyHtml += '    \n';
bodyHtml += '    let newLang = select.value;\n';
bodyHtml += '    if (select.value === "Other") {\n';
bodyHtml += '        newLang = customInput.value.trim();\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    if (!newLang || newLang === "") {\n';
bodyHtml += '        alert("Please select or enter a language");\n';
bodyHtml += '        return;\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    // Check if language already exists\n';
bodyHtml += '    if (surveyLanguages.includes(newLang)) {\n';
bodyHtml += '        alert("This language already exists in the survey");\n';
bodyHtml += '        return;\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    // Add to local array\n';
bodyHtml += '    surveyLanguages.push(newLang);\n';
bodyHtml += '    \n';
bodyHtml += '    // Save to server\n';
bodyHtml += '    try {\n';
bodyHtml += '        const response = await fetch("/api/admin/survey-config/" + surveyId, {\n';
bodyHtml += '            method: "PUT",\n';
bodyHtml += '            credentials: "same-origin",\n';
bodyHtml += '            headers: { "Content-Type": "application/json" },\n';
bodyHtml += '            body: JSON.stringify({ languages: JSON.stringify(surveyLanguages) })\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            alert("Language added successfully. Page will reload to update all fields.");\n';
bodyHtml += '            location.reload();\n';
bodyHtml += '        } else {\n';
bodyHtml += '            const result = await response.json();\n';
bodyHtml += '            alert("Failed to add language: " + result.error);\n';
bodyHtml += '            // Remove from local array on failure\n';
bodyHtml += '            surveyLanguages.pop();\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        alert("Error: " + error.message);\n';
bodyHtml += '        surveyLanguages.pop();\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function removeLanguage(lang) {\n';
bodyHtml += '    if (surveyLanguages.length <= 1) {\n';
bodyHtml += '        alert("Cannot remove the last language");\n';
bodyHtml += '        return;\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    if (!confirm("Are you sure you want to remove " + lang + "? This will delete all text and audio for this language.")) {\n';
bodyHtml += '        return;\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    // Remove from local array\n';
bodyHtml += '    const index = surveyLanguages.indexOf(lang);\n';
bodyHtml += '    if (index > -1) {\n';
bodyHtml += '        surveyLanguages.splice(index, 1);\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    // Save to server\n';
bodyHtml += '    try {\n';
bodyHtml += '        const response = await fetch("/api/admin/survey-config/" + surveyId, {\n';
bodyHtml += '            method: "PUT",\n';
bodyHtml += '            credentials: "same-origin",\n';
bodyHtml += '            headers: { "Content-Type": "application/json" },\n';
bodyHtml += '            body: JSON.stringify({ languages: JSON.stringify(surveyLanguages) })\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            alert("Language removed successfully. Page will reload to update all fields.");\n';
bodyHtml += '            location.reload();\n';
bodyHtml += '        } else {\n';
bodyHtml += '            const result = await response.json();\n';
bodyHtml += '            alert("Failed to remove language: " + result.error);\n';
bodyHtml += '            // Add back to local array on failure\n';
bodyHtml += '            surveyLanguages.push(lang);\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        alert("Error: " + error.message);\n';
bodyHtml += '        surveyLanguages.push(lang);\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';

// Drag and drop functions
bodyHtml += 'function initializeDragAndDrop() {\n';
bodyHtml += '    document.querySelectorAll(".question-item").forEach(item => {\n';
bodyHtml += '        item.addEventListener("dragstart", handleDragStart);\n';
bodyHtml += '        item.addEventListener("dragend", handleDragEnd);\n';
bodyHtml += '        item.addEventListener("dragover", handleDragOver);\n';
bodyHtml += '        item.addEventListener("drop", handleDrop);\n';
bodyHtml += '        item.addEventListener("dragenter", handleDragEnter);\n';
bodyHtml += '        item.addEventListener("dragleave", handleDragLeave);\n';
bodyHtml += '    });\n';
bodyHtml += '    \n';
bodyHtml += '    // Allow dropping in empty sections\n';
bodyHtml += '    document.querySelectorAll(".section-questions").forEach(section => {\n';
bodyHtml += '        section.addEventListener("dragover", handleSectionDragOver);\n';
bodyHtml += '        section.addEventListener("drop", handleSectionDrop);\n';
bodyHtml += '        section.addEventListener("dragleave", handleSectionDragLeave);\n';
bodyHtml += '    });\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDragStart(e) {\n';
bodyHtml += '    draggedElement = this;\n';
bodyHtml += '    this.classList.add("dragging");\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDragEnd(e) {\n';
bodyHtml += '    this.classList.remove("dragging");\n';
bodyHtml += '    document.querySelectorAll(".question-item").forEach(item => {\n';
bodyHtml += '        item.classList.remove("drag-over");\n';
bodyHtml += '    });\n';
bodyHtml += '    document.querySelectorAll(".section-questions").forEach(section => {\n';
bodyHtml += '        section.classList.remove("drag-over");\n';
bodyHtml += '    });\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDragOver(e) {\n';
bodyHtml += '    e.preventDefault();\n';
bodyHtml += '    return false;\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDragEnter(e) {\n';
bodyHtml += '    this.classList.add("drag-over");\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDragLeave(e) {\n';
bodyHtml += '    this.classList.remove("drag-over");\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleDrop(e) {\n';
bodyHtml += '    e.stopPropagation();\n';
bodyHtml += '    \n';
bodyHtml += '    if (draggedElement !== this) {\n';
bodyHtml += '        const allItems = Array.from(document.querySelectorAll(".question-item"));\n';
bodyHtml += '        const draggedIndex = allItems.indexOf(draggedElement);\n';
bodyHtml += '        const targetIndex = allItems.indexOf(this);\n';
bodyHtml += '        \n';
bodyHtml += '        // Move the element\n';
bodyHtml += '        if (draggedIndex < targetIndex) {\n';
bodyHtml += '            this.parentNode.insertBefore(draggedElement, this.nextSibling);\n';
bodyHtml += '        } else {\n';
bodyHtml += '            this.parentNode.insertBefore(draggedElement, this);\n';
bodyHtml += '        }\n';
bodyHtml += '        \n';
bodyHtml += '        // Get the section AFTER moving the element\n';
bodyHtml += '        const newSection = draggedElement.closest(".section-questions");\n';
bodyHtml += '        const newSectionId = newSection ? newSection.dataset.sectionId : null;\n';
bodyHtml += '        \n';
bodyHtml += '        // Update the question section if it was moved to a different section\n';
bodyHtml += '        if (newSectionId) {\n';
bodyHtml += '            const questionId = draggedElement.dataset.questionId;\n';
bodyHtml += '            console.log("Moving question " + questionId + " to section " + newSectionId);\n';
bodyHtml += '            updateQuestionSection(questionId, newSectionId);\n';
bodyHtml += '        }\n';
bodyHtml += '        \n';
bodyHtml += '        updateQuestionOrder();\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    return false;\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function updateQuestionOrder() {\n';
bodyHtml += '    const items = document.querySelectorAll(".question-item");\n';
bodyHtml += '    questionOrder = Array.from(items).map(item => parseInt(item.dataset.questionId));\n';
bodyHtml += '    \n';
bodyHtml += '    items.forEach((item, index) => {\n';
bodyHtml += '        const numberSpan = item.querySelector(".question-number");\n';
bodyHtml += '        if (numberSpan) {\n';
bodyHtml += '            numberSpan.textContent = "Q" + (index + 1);\n';
bodyHtml += '        }\n';
bodyHtml += '    });\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function saveQuestionOrder() {\n';
bodyHtml += '    try {\n';
bodyHtml += '        const response = await fetch("/api/admin/survey-config/" + surveyId + "/reorder", {\n';
bodyHtml += '            method: "POST",\n';
bodyHtml += '            headers: { "Content-Type": "application/json" },\n';
bodyHtml += '            body: JSON.stringify({ questionOrder })\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            alert("Question order saved");\n';
bodyHtml += '        } else {\n';
bodyHtml += '            const result = await response.json();\n';
bodyHtml += '            alert("Failed to save order: " + result.error);\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        alert("Error: " + error.message);\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';

// Modal functions
bodyHtml += 'function newQuestion() {\n';
bodyHtml += '    // Set modal title\n';
bodyHtml += '    document.getElementById("modalTitle").textContent = "New Question";\n';
bodyHtml += '    \n';
bodyHtml += '    // Clear the form for new question\n';
bodyHtml += '    document.getElementById("questionId").value = "";\n';
bodyHtml += '    document.getElementById("shortName").value = "";\n';
bodyHtml += '    document.getElementById("questionType").value = "multiple_choice";\n';
bodyHtml += '    document.getElementById("preScript").value = "";\n';
bodyHtml += '    document.getElementById("validationScript").value = "";\n';
bodyHtml += '    \n';
bodyHtml += '    // Set default section (main survey section)\n';
bodyHtml += '    const mainSection = sectionsData.find(s => s.section_type === "main");\n';
bodyHtml += '    if (mainSection) {\n';
bodyHtml += '        document.getElementById("sectionId").value = mainSection.id;\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    // Clear text inputs and audio for each language\n';
bodyHtml += '    surveyLanguages.forEach(lang => {\n';
bodyHtml += '        const langId = lang.replace(/\\s+/g, "_");\n';
bodyHtml += '        const textInput = document.getElementById("text_" + langId);\n';
bodyHtml += '        if (textInput) textInput.value = "";\n';
bodyHtml += '        \n';
bodyHtml += '        const audioInput = document.getElementById("audio_" + langId);\n';
bodyHtml += '        if (audioInput) audioInput.value = "";\n';
bodyHtml += '        \n';
bodyHtml += '        const playBtn = document.getElementById("play_" + langId);\n';
bodyHtml += '        if (playBtn) playBtn.style.display = "none";\n';
bodyHtml += '    });\n';
bodyHtml += '    \n';
bodyHtml += '    // Clear options\n';
bodyHtml += '    document.getElementById("optionsList").innerHTML = "";\n';
bodyHtml += '    \n';
bodyHtml += '    toggleOptionsSection();\n';
bodyHtml += '    document.getElementById("editModal").style.display = "block";\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function editQuestion(questionId) {\n';
bodyHtml += '    // Set modal title\n';
bodyHtml += '    document.getElementById("modalTitle").textContent = "Edit Question";\n';
bodyHtml += '    \n';
bodyHtml += '    const question = questionsData.find(q => q.id === questionId);\n';
bodyHtml += '    if (!question) return;\n';
bodyHtml += '    \n';
bodyHtml += '    document.getElementById("questionId").value = questionId;\n';
bodyHtml += '    document.getElementById("shortName").value = question.short_name;\n';
bodyHtml += '    document.getElementById("questionType").value = question.question_type;\n';
bodyHtml += '    document.getElementById("preScript").value = question.pre_script || "";\n';
bodyHtml += '    document.getElementById("validationScript").value = question.validation_script || "";\n';
bodyHtml += '    document.getElementById("sectionId").value = question.section_id || "";\n';
bodyHtml += '    \n';
bodyHtml += '    // Load min/max selections for multi_select questions\n';
bodyHtml += '    if (question.question_type === "multi_select") {\n';
bodyHtml += '        const minSelectionsInput = document.getElementById("minSelections");\n';
bodyHtml += '        const maxSelectionsInput = document.getElementById("maxSelections");\n';
bodyHtml += '        if (minSelectionsInput) minSelectionsInput.value = question.min_selections || "";\n';
bodyHtml += '        if (maxSelectionsInput) maxSelectionsInput.value = question.max_selections || "";\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    // Set text and audio for each language\n';
bodyHtml += '    surveyLanguages.forEach(lang => {\n';
bodyHtml += '        const langId = lang.replace(/\\s+/g, "_");\n';
bodyHtml += '        \n';
bodyHtml += '        const textInput = document.getElementById("text_" + langId);\n';
bodyHtml += '        if (textInput) textInput.value = question.texts[lang] || "";\n';
bodyHtml += '        \n';
bodyHtml += '        const audioInput = document.getElementById("audio_" + langId);\n';
bodyHtml += '        const playBtn = document.getElementById("play_" + langId);\n';
bodyHtml += '        if (audioInput && question.audioFiles && question.audioFiles[lang]) {\n';
bodyHtml += '            audioInput.value = question.audioFiles[lang];\n';
bodyHtml += '            if (playBtn) playBtn.style.display = "inline-block";\n';
bodyHtml += '        } else {\n';
bodyHtml += '            if (audioInput) audioInput.value = "";\n';
bodyHtml += '            if (playBtn) playBtn.style.display = "none";\n';
bodyHtml += '        }\n';
bodyHtml += '    });\n';
bodyHtml += '    \n';
bodyHtml += '    // Setup options if multiple choice or multi_select\n';
bodyHtml += '    if (question.question_type === "multiple_choice" || question.question_type === "multi_select") {\n';
bodyHtml += '        loadOptions(question.options);\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    toggleOptionsSection();\n';
bodyHtml += '    document.getElementById("editModal").style.display = "block";\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function loadOptions(options) {\n';
bodyHtml += '    const container = document.getElementById("optionsList");\n';
bodyHtml += '    container.innerHTML = "";\n';
bodyHtml += '    \n';
bodyHtml += '    options.forEach((opt, idx) => {\n';
bodyHtml += '        const optTexts = typeof opt.option_text_json === "string" ? \n';
bodyHtml += '            JSON.parse(opt.option_text_json) : opt.option_text_json || {};\n';
bodyHtml += '        const optAudio = typeof opt.audio_files_json === "string" ? \n';
bodyHtml += '            JSON.parse(opt.audio_files_json) : opt.audio_files_json || {};\n';
bodyHtml += '        addOptionWithData(optTexts, optAudio);\n';
bodyHtml += '    });\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function addOption() {\n';
bodyHtml += '    addOptionWithData({});\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function addOptionWithData(texts, audioData) {\n';
bodyHtml += '    const container = document.getElementById("optionsList");\n';
bodyHtml += '    const optionDiv = document.createElement("div");\n';
bodyHtml += '    const optionIndex = container.children.length;\n';
bodyHtml += '    optionDiv.className = "option-wrapper";\n';
bodyHtml += '    optionDiv.style.marginBottom = "1rem";\n';
bodyHtml += '    optionDiv.style.padding = "0.5rem";\n';
bodyHtml += '    optionDiv.style.border = "1px solid #ddd";\n';
bodyHtml += '    optionDiv.style.borderRadius = "4px";\n';
bodyHtml += '    \n';
bodyHtml += '    let html = "";\n';
bodyHtml += '    surveyLanguages.forEach(lang => {\n';
bodyHtml += '        const langId = lang.replace(/\\s+/g, "_");\n';
bodyHtml += '        const optId = "opt_" + optionIndex + "_" + langId;\n';
bodyHtml += '        html += \'<div style="margin-bottom: 0.5rem;">\';\n';
bodyHtml += '        html += \'  <div style="display: flex; gap: 0.5rem; align-items: center;">\';\n';
bodyHtml += '        html += \'    <input type="text" class="form-control option-text" data-lang="\' + lang + \'" placeholder="\' + lang + \' option" value="\' + (texts[lang] || "") + \'" style="flex: 1;">\';\n';
bodyHtml += '        html += \'    <button type="button" onclick="toggleOptionRecording(\\\'\' + optId + \'\\\')" class="btn btn-sm" style="width: 100px;">üé§ Record</button>\';\n';
bodyHtml += '        html += \'    <button type="button" onclick="playOptionAudio(\\\'\' + optId + \'\\\')" class="btn btn-sm" style="display: \' + (audioData && audioData[lang] ? "inline-block" : "none") + \';">‚ñ∂Ô∏è Play</button>\';\n';
bodyHtml += '        html += \'  </div>\';\n';
bodyHtml += '        html += \'  <input type="hidden" class="option-audio" data-lang="\' + lang + \'" id="audio_\' + optId + \'" value="\' + (audioData && audioData[lang] || "") + \'">\';\n';
bodyHtml += '        html += \'</div>\';\n';
bodyHtml += '    });\n';
bodyHtml += '    html += \'<button type="button" onclick="removeOption(this)" class="btn btn-danger btn-sm">Remove Option</button>\';\n';
bodyHtml += '    \n';
bodyHtml += '    optionDiv.innerHTML = html;\n';
bodyHtml += '    container.appendChild(optionDiv);\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function removeOption(button) {\n';
bodyHtml += '    button.parentElement.remove();\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function toggleOptionsSection() {\n';
bodyHtml += '    const type = document.getElementById("questionType").value;\n';
bodyHtml += '    const showOptions = type === "multiple_choice" || type === "multi_select";\n';
bodyHtml += '    document.getElementById("optionsSection").style.display = showOptions ? "block" : "none";\n';
bodyHtml += '    \n';
bodyHtml += '    // Show/hide multi-select specific fields\n';
bodyHtml += '    const multiSelectFields = document.getElementById("multiSelectFields");\n';
bodyHtml += '    if (multiSelectFields) {\n';
bodyHtml += '        multiSelectFields.style.display = type === "multi_select" ? "block" : "none";\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function closeModal() {\n';
bodyHtml += '    document.getElementById("editModal").style.display = "none";\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function saveQuestion() {\n';
bodyHtml += '    const questionId = document.getElementById("questionId").value;\n';
bodyHtml += '    const isNewQuestion = !questionId;\n';
bodyHtml += '    \n';
bodyHtml += '    // Collect texts and audio\n';
bodyHtml += '    const texts = {};\n';
bodyHtml += '    const audioFiles = {};\n';
bodyHtml += '    surveyLanguages.forEach(lang => {\n';
bodyHtml += '        const langId = lang.replace(/\\s+/g, "_");\n';
bodyHtml += '        const value = document.getElementById("text_" + langId).value;\n';
bodyHtml += '        if (value) texts[lang] = value;\n';
bodyHtml += '        \n';
bodyHtml += '        const audioValue = document.getElementById("audio_" + langId).value;\n';
bodyHtml += '        if (audioValue && audioValue.length > 0) {\n';
bodyHtml += '            audioFiles[lang] = audioValue;\n';
bodyHtml += '            console.log("Audio saved for " + lang + ", length: " + audioValue.length);\n';
bodyHtml += '        }\n';
bodyHtml += '    });\n';
bodyHtml += '    \n';
bodyHtml += '    // Collect options if multiple choice or multi_select\n';
bodyHtml += '    const questionType = document.getElementById("questionType").value;\n';
bodyHtml += '    const options = [];\n';
bodyHtml += '    if (questionType === "multiple_choice" || questionType === "multi_select") {\n';
bodyHtml += '        document.querySelectorAll(".option-wrapper").forEach((group, idx) => {\n';
bodyHtml += '            const optionTexts = {};\n';
bodyHtml += '            const optionAudio = {};\n';
bodyHtml += '            \n';
bodyHtml += '            group.querySelectorAll(".option-text").forEach(input => {\n';
bodyHtml += '                if (input.value) optionTexts[input.dataset.lang] = input.value;\n';
bodyHtml += '            });\n';
bodyHtml += '            \n';
bodyHtml += '            group.querySelectorAll(".option-audio").forEach(input => {\n';
bodyHtml += '                if (input.value) {\n';
bodyHtml += '                    optionAudio[input.dataset.lang] = input.value;\n';
bodyHtml += '                    console.log("Option audio saved for " + input.dataset.lang + ", length: " + input.value.length);\n';
bodyHtml += '                }\n';
bodyHtml += '            });\n';
bodyHtml += '            \n';
bodyHtml += '            options.push({\n';
bodyHtml += '                option_index: idx,\n';
bodyHtml += '                text_json: optionTexts,\n';
bodyHtml += '                audio_json: optionAudio\n';
bodyHtml += '            });\n';
bodyHtml += '        });\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    const data = {\n';
bodyHtml += '        short_name: document.getElementById("shortName").value,\n';
bodyHtml += '        question_text_json: texts,\n';
bodyHtml += '        question_type: questionType,\n';
bodyHtml += '        pre_script: document.getElementById("preScript").value || null,\n';
bodyHtml += '        validation_script: document.getElementById("validationScript").value || null,\n';
bodyHtml += '        audio_files_json: audioFiles,\n';
bodyHtml += '        validation_error_json: {},\n';
bodyHtml += '        section_id: parseInt(document.getElementById("sectionId").value),\n';
bodyHtml += '        options: options\n';
bodyHtml += '    };\n';
bodyHtml += '    \n';
bodyHtml += '    // Add min/max selections for multi_select questions\n';
bodyHtml += '    if (questionType === "multi_select") {\n';
bodyHtml += '        const minSelections = document.getElementById("minSelections")?.value;\n';
bodyHtml += '        const maxSelections = document.getElementById("maxSelections")?.value;\n';
bodyHtml += '        if (minSelections) data.min_selections = parseInt(minSelections);\n';
bodyHtml += '        if (maxSelections) data.max_selections = parseInt(maxSelections);\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    // For new questions, add at the end\n';
bodyHtml += '    if (isNewQuestion) {\n';
bodyHtml += '        data.question_index = questionsData.length;\n';
bodyHtml += '    } else {\n';
bodyHtml += '        const question = questionsData.find(q => q.id === parseInt(questionId));\n';
bodyHtml += '        data.question_index = question.question_index;\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    try {\n';
bodyHtml += '        let url, method;\n';
bodyHtml += '        if (isNewQuestion) {\n';
bodyHtml += '            url = "/api/admin/survey-config/" + surveyId + "/questions";\n';
bodyHtml += '            method = "POST";\n';
bodyHtml += '        } else {\n';
bodyHtml += '            url = "/api/admin/survey-config/" + surveyId + "/questions/" + questionId;\n';
bodyHtml += '            method = "PUT";\n';
bodyHtml += '        }\n';
bodyHtml += '        \n';
bodyHtml += '        const response = await fetch(url, {\n';
bodyHtml += '            method: method,\n';
bodyHtml += '            headers: { "Content-Type": "application/json" },\n';
bodyHtml += '            body: JSON.stringify(data)\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            alert(isNewQuestion ? "Question created successfully" : "Question updated successfully");\n';
bodyHtml += '            location.reload();\n';
bodyHtml += '        } else {\n';
bodyHtml += '            const result = await response.json();\n';
bodyHtml += '            console.error("Server response:", result);\n';
bodyHtml += '            if (result.errors && Array.isArray(result.errors)) {\n';
bodyHtml += '                const errorMessages = result.errors.map(err => err.msg || err.message).join(", ");\n';
bodyHtml += '                alert("Failed to save: " + errorMessages);\n';
bodyHtml += '            } else {\n';
bodyHtml += '                alert("Failed to save: " + (result.error || JSON.stringify(result)));\n';
bodyHtml += '            }\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        alert("Error: " + error.message);\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += '// Close modal when clicking outside\n';
bodyHtml += 'window.onclick = function(event) {\n';
bodyHtml += '    const modal = document.getElementById("editModal");\n';
bodyHtml += '    if (event.target === modal) {\n';
bodyHtml += '        closeModal();\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += '// Audio recording functionality\n';
bodyHtml += 'let mediaRecorder = null;\n';
bodyHtml += 'let audioChunks = [];\n';
bodyHtml += 'let currentRecordingLang = null;\n';
bodyHtml += '\n';
bodyHtml += '// Convert audio blob to MP3 using lamejs\n';
bodyHtml += 'async function convertToMp3(audioBlob) {\n';
bodyHtml += '    return new Promise(async (resolve, reject) => {\n';
bodyHtml += '        try {\n';
bodyHtml += '            // Create audio context to decode the WebM audio\n';
bodyHtml += '            const audioContext = new (window.AudioContext || window.webkitAudioContext)();\n';
bodyHtml += '            const arrayBuffer = await audioBlob.arrayBuffer();\n';
bodyHtml += '            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);\n';
bodyHtml += '            \n';
bodyHtml += '            // Get audio data\n';
bodyHtml += '            const channels = audioBuffer.numberOfChannels;\n';
bodyHtml += '            const sampleRate = audioBuffer.sampleRate;\n';
bodyHtml += '            const samples = audioBuffer.length;\n';
bodyHtml += '            \n';
bodyHtml += '            // Convert to 16-bit PCM\n';
bodyHtml += '            const leftChannel = audioBuffer.getChannelData(0);\n';
bodyHtml += '            const rightChannel = channels > 1 ? audioBuffer.getChannelData(1) : leftChannel;\n';
bodyHtml += '            \n';
bodyHtml += '            // Convert float samples to 16-bit PCM\n';
bodyHtml += '            const left = new Int16Array(samples);\n';
bodyHtml += '            const right = new Int16Array(samples);\n';
bodyHtml += '            for (let i = 0; i < samples; i++) {\n';
bodyHtml += '                left[i] = Math.max(-32768, Math.min(32767, leftChannel[i] * 32768));\n';
bodyHtml += '                right[i] = Math.max(-32768, Math.min(32767, rightChannel[i] * 32768));\n';
bodyHtml += '            }\n';
bodyHtml += '            \n';
bodyHtml += '            // Create MP3 encoder\n';
bodyHtml += '            const mp3Encoder = new lamejs.Mp3Encoder(channels, sampleRate, 128);\n';
bodyHtml += '            const mp3Data = [];\n';
bodyHtml += '            \n';
bodyHtml += '            // Encode in chunks\n';
bodyHtml += '            const blockSize = 1152;\n';
bodyHtml += '            for (let i = 0; i < samples; i += blockSize) {\n';
bodyHtml += '                const leftChunk = left.subarray(i, Math.min(i + blockSize, samples));\n';
bodyHtml += '                const rightChunk = right.subarray(i, Math.min(i + blockSize, samples));\n';
bodyHtml += '                const mp3buf = mp3Encoder.encodeBuffer(leftChunk, rightChunk);\n';
bodyHtml += '                if (mp3buf.length > 0) {\n';
bodyHtml += '                    mp3Data.push(mp3buf);\n';
bodyHtml += '                }\n';
bodyHtml += '            }\n';
bodyHtml += '            \n';
bodyHtml += '            // Flush encoder\n';
bodyHtml += '            const mp3buf = mp3Encoder.flush();\n';
bodyHtml += '            if (mp3buf.length > 0) {\n';
bodyHtml += '                mp3Data.push(mp3buf);\n';
bodyHtml += '            }\n';
bodyHtml += '            \n';
bodyHtml += '            // Create blob and convert to base64\n';
bodyHtml += '            const mp3Blob = new Blob(mp3Data, { type: "audio/mp3" });\n';
bodyHtml += '            const reader = new FileReader();\n';
bodyHtml += '            reader.onloadend = () => {\n';
bodyHtml += '                resolve(reader.result);\n';
bodyHtml += '            };\n';
bodyHtml += '            reader.onerror = reject;\n';
bodyHtml += '            reader.readAsDataURL(mp3Blob);\n';
bodyHtml += '        } catch (error) {\n';
bodyHtml += '            reject(error);\n';
bodyHtml += '        }\n';
bodyHtml += '    });\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function toggleRecording(langId) {\n';
bodyHtml += '    const recordBtn = document.getElementById("record_" + langId);\n';
bodyHtml += '    const playBtn = document.getElementById("play_" + langId);\n';
bodyHtml += '    \n';
bodyHtml += '    if (mediaRecorder && mediaRecorder.state === "recording") {\n';
bodyHtml += '        // Stop recording\n';
bodyHtml += '        mediaRecorder.stop();\n';
bodyHtml += '        recordBtn.textContent = "üé§ Record";\n';
bodyHtml += '        recordBtn.style.background = "";\n';
bodyHtml += '    } else {\n';
bodyHtml += '        // Start recording\n';
bodyHtml += '        try {\n';
bodyHtml += '            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n';
bodyHtml += '            mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });\n';
bodyHtml += '            audioChunks = [];\n';
bodyHtml += '            currentRecordingLang = langId;\n';
bodyHtml += '            \n';
bodyHtml += '            mediaRecorder.ondataavailable = (event) => {\n';
bodyHtml += '                audioChunks.push(event.data);\n';
bodyHtml += '            };\n';
bodyHtml += '            \n';
bodyHtml += '            mediaRecorder.onstop = async () => {\n';
bodyHtml += '                const audioBlob = new Blob(audioChunks, { type: "audio/webm" });\n';
bodyHtml += '                \n';
bodyHtml += '                // Convert WebM to MP3\n';
bodyHtml += '                try {\n';
bodyHtml += '                    console.log("Converting audio to MP3...");\n';
bodyHtml += '                    const mp3Base64 = await convertToMp3(audioBlob);\n';
bodyHtml += '                    console.log("MP3 conversion successful, length:", mp3Base64.length);\n';
bodyHtml += '                    document.getElementById("audio_" + currentRecordingLang).value = mp3Base64;\n';
bodyHtml += '                    \n';
bodyHtml += '                    // Show play button\n';
bodyHtml += '                    document.getElementById("play_" + currentRecordingLang).style.display = "inline-block";\n';
bodyHtml += '                } catch (error) {\n';
bodyHtml += '                    console.error("Error converting to MP3:", error);\n';
bodyHtml += '                    alert("Error converting audio to MP3: " + error.message);\n';
bodyHtml += '                }\n';
bodyHtml += '                \n';
bodyHtml += '                // Stop all tracks\n';
bodyHtml += '                stream.getTracks().forEach(track => track.stop());\n';
bodyHtml += '            };\n';
bodyHtml += '            \n';
bodyHtml += '            mediaRecorder.start();\n';
bodyHtml += '            recordBtn.textContent = "‚èπ Stop";\n';
bodyHtml += '            recordBtn.style.background = "#e74c3c";\n';
bodyHtml += '        } catch (error) {\n';
bodyHtml += '            alert("Error accessing microphone: " + error.message);\n';
bodyHtml += '        }\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function playAudio(langId) {\n';
bodyHtml += '    const audioData = document.getElementById("audio_" + langId).value;\n';
bodyHtml += '    if (audioData) {\n';
bodyHtml += '        const audio = new Audio(audioData);\n';
bodyHtml += '        audio.play();\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += '// Option audio recording functions\n';
bodyHtml += 'async function toggleOptionRecording(optId) {\n';
bodyHtml += '    const recordBtn = event.target;\n';
bodyHtml += '    const audioInput = document.getElementById("audio_" + optId);\n';
bodyHtml += '    const playBtn = recordBtn.parentElement.querySelector("button:nth-child(3)");\n';
bodyHtml += '    \n';
bodyHtml += '    if (mediaRecorder && mediaRecorder.state === "recording") {\n';
bodyHtml += '        // Stop recording\n';
bodyHtml += '        mediaRecorder.stop();\n';
bodyHtml += '        recordBtn.textContent = "üé§ Record";\n';
bodyHtml += '        recordBtn.style.background = "";\n';
bodyHtml += '    } else {\n';
bodyHtml += '        // Start recording\n';
bodyHtml += '        try {\n';
bodyHtml += '            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n';
bodyHtml += '            mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });\n';
bodyHtml += '            audioChunks = [];\n';
bodyHtml += '            \n';
bodyHtml += '            mediaRecorder.ondataavailable = (event) => {\n';
bodyHtml += '                audioChunks.push(event.data);\n';
bodyHtml += '            };\n';
bodyHtml += '            \n';
bodyHtml += '            mediaRecorder.onstop = async () => {\n';
bodyHtml += '                const audioBlob = new Blob(audioChunks, { type: "audio/webm" });\n';
bodyHtml += '                \n';
bodyHtml += '                // Convert WebM to MP3\n';
bodyHtml += '                try {\n';
bodyHtml += '                    console.log("Converting option audio to MP3...");\n';
bodyHtml += '                    const mp3Base64 = await convertToMp3(audioBlob);\n';
bodyHtml += '                    console.log("Option MP3 conversion successful, length:", mp3Base64.length);\n';
bodyHtml += '                    audioInput.value = mp3Base64;\n';
bodyHtml += '                    \n';
bodyHtml += '                    // Show play button\n';
bodyHtml += '                    if (playBtn) playBtn.style.display = "inline-block";\n';
bodyHtml += '                } catch (error) {\n';
bodyHtml += '                    console.error("Error converting option to MP3:", error);\n';
bodyHtml += '                    alert("Error converting audio to MP3: " + error.message);\n';
bodyHtml += '                }\n';
bodyHtml += '                \n';
bodyHtml += '                // Stop all tracks\n';
bodyHtml += '                stream.getTracks().forEach(track => track.stop());\n';
bodyHtml += '            };\n';
bodyHtml += '            \n';
bodyHtml += '            mediaRecorder.start();\n';
bodyHtml += '            recordBtn.textContent = "‚èπ Stop";\n';
bodyHtml += '            recordBtn.style.background = "#e74c3c";\n';
bodyHtml += '        } catch (error) {\n';
bodyHtml += '            alert("Error accessing microphone: " + error.message);\n';
bodyHtml += '        }\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function playOptionAudio(optId) {\n';
bodyHtml += '    const audioData = document.getElementById("audio_" + optId).value;\n';
bodyHtml += '    if (audioData) {\n';
bodyHtml += '        const audio = new Audio(audioData);\n';
bodyHtml += '        audio.play();\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleSectionDragOver(e) {\n';
bodyHtml += '    if (e.preventDefault) {\n';
bodyHtml += '        e.preventDefault();\n';
bodyHtml += '    }\n';
bodyHtml += '    this.classList.add("drag-over");\n';
bodyHtml += '    return false;\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleSectionDragLeave(e) {\n';
bodyHtml += '    this.classList.remove("drag-over");\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'function handleSectionDrop(e) {\n';
bodyHtml += '    e.stopPropagation();\n';
bodyHtml += '    e.preventDefault();\n';
bodyHtml += '    this.classList.remove("drag-over");\n';
bodyHtml += '    \n';
bodyHtml += '    // Only handle if dropped on empty section or section with questions\n';
bodyHtml += '    if (draggedElement && this.classList.contains("section-questions")) {\n';
bodyHtml += '        const sectionId = this.dataset.sectionId;\n';
bodyHtml += '        const questionId = draggedElement.dataset.questionId;\n';
bodyHtml += '        \n';
bodyHtml += '        // Append to this section\n';
bodyHtml += '        this.appendChild(draggedElement);\n';
bodyHtml += '        \n';
bodyHtml += '        // Update the question section\n';
bodyHtml += '        console.log("Section drop: Moving question " + questionId + " to section " + sectionId);\n';
bodyHtml += '        updateQuestionSection(questionId, sectionId);\n';
bodyHtml += '        \n';
bodyHtml += '        // Update the question order\n';
bodyHtml += '        updateQuestionOrder();\n';
bodyHtml += '    }\n';
bodyHtml += '    \n';
bodyHtml += '    return false;\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += 'async function updateQuestionSection(questionId, sectionId) {\n';
bodyHtml += '    try {\n';
bodyHtml += '        console.log("Updating question " + questionId + " to section " + sectionId);\n';
bodyHtml += '        const response = await fetch("/api/admin/survey-config/" + surveyId + "/questions/" + questionId, {\n';
bodyHtml += '            method: "PUT",\n';
bodyHtml += '            credentials: "same-origin",\n';
bodyHtml += '            headers: { "Content-Type": "application/json" },\n';
bodyHtml += '            body: JSON.stringify({ section_id: parseInt(sectionId) })\n';
bodyHtml += '        });\n';
bodyHtml += '        \n';
bodyHtml += '        if (response.ok) {\n';
bodyHtml += '            console.log("Successfully updated question section");\n';
bodyHtml += '            // Update the local data\n';
bodyHtml += '            const question = questionsData.find(q => q.id == questionId);\n';
bodyHtml += '            if (question) {\n';
bodyHtml += '                question.section_id = parseInt(sectionId);\n';
bodyHtml += '            }\n';
bodyHtml += '        } else {\n';
bodyHtml += '            const result = await response.json();\n';
bodyHtml += '            console.error("Failed to update question section:", result.error);\n';
bodyHtml += '        }\n';
bodyHtml += '    } catch (error) {\n';
bodyHtml += '        console.error("Error updating question section:", error);\n';
bodyHtml += '    }\n';
bodyHtml += '}\n';
bodyHtml += '\n';
bodyHtml += '// Initialize on load\n';
bodyHtml += 'document.addEventListener("DOMContentLoaded", function() {\n';
bodyHtml += '    initializeDragAndDrop();\n';
bodyHtml += '    loadSystemMessages();\n';
bodyHtml += '});\n';
bodyHtml += '</script>\n';

var body = bodyHtml;
%>
<%- include('../layouts/main', { title: 'Edit Survey: ' + survey.name, username: username, body: body }) %>