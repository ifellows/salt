<% var body = ` 
<h2>Survey Configuration</h2>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Survey Versions</h3>
        <a href="/surveys/new" class="btn">Create New Survey</a>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Version</th>
                <th>Name</th>
                <th>Description</th>
                <th>Languages</th>
                <th>Questions</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            ${surveys.map(survey => `
                <tr>
                    <td>v${survey.version}</td>
                    <td>${survey.name}</td>
                    <td>${survey.description || '-'}</td>
                    <td>${survey.languages ? (typeof survey.languages === 'string' ? JSON.parse(survey.languages).join(', ') : survey.languages.join(', ')) : 'en'}</td>
                    <td>${survey.question_count}</td>
                    <td>
                        ${survey.is_active ? 
                            '<span style="color: green; font-weight: bold;">Active</span>' : 
                            '<span style="color: gray;">Inactive</span>'
                        }
                    </td>
                    <td>
                        <a href="/surveys/${survey.id}/edit" class="btn" style="padding: 0.25rem 0.5rem;">Edit</a>
                        ${!survey.is_active ? 
                            `<button onclick="activateSurvey(${survey.id})" class="btn" style="padding: 0.25rem 0.5rem; margin-left: 0.5rem;">Activate</button>` : 
                            ''
                        }
                        <button onclick="cloneSurvey(${survey.id})" class="btn" style="padding: 0.25rem 0.5rem; margin-left: 0.5rem;">Clone</button>
                        ${!survey.is_active ? 
                            `<button onclick="deleteSurvey(${survey.id}, '${survey.name.replace(/'/g, "\\'")}')" class="btn btn-danger" style="padding: 0.25rem 0.5rem; margin-left: 0.5rem;">Delete</button>` : 
                            ''
                        }
                    </td>
                </tr>
            `).join('')}
            ${surveys.length === 0 ? '<tr><td colspan="6" style="text-align: center;">No surveys configured</td></tr>' : ''}
        </tbody>
    </table>
</div>

<script>
async function activateSurvey(surveyId) {
    if (!confirm('Activate this survey? This will deactivate all other surveys.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/admin/survey-config/' + surveyId + '/activate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Survey activated successfully');
            location.reload();
        } else {
            alert('Failed to activate survey: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function cloneSurvey(surveyId) {
    const name = prompt('Enter name for the cloned survey:');
    if (!name) return;
    
    try {
        const response = await fetch('/api/admin/survey-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: 'Cloned survey',
                basedOnSurveyId: surveyId
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Survey cloned successfully as version ' + result.version);
            location.reload();
        } else {
            alert('Failed to clone survey: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteSurvey(surveyId, surveyName) {
    // Double confirmation for safety
    if (!confirm('Are you sure you want to delete the survey "' + surveyName + '"?\\n\\nThis action cannot be undone.')) {
        return;
    }
    
    if (!confirm('This will permanently delete all questions and options for "' + surveyName + '". Are you absolutely sure?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/admin/survey-config/' + surveyId, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Survey deleted successfully');
            location.reload();
        } else {
            alert('Failed to delete survey: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
` %>
<%- include('../layouts/main', { body: body }) %>