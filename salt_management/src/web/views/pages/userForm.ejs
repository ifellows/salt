<%- include('../partials/header') %>
<%- include('../partials/nav') %>

<div class="container">
    <div class="card" style="max-width: 600px; margin: 0 auto;">
        <h2><%= title %></h2>

        <% if (error) { %>
            <div class="alert alert-error">
                <%= error %>
            </div>
        <% } %>

        <form id="userForm">
            <div class="form-group">
                <label for="username">Username *</label>
                <input type="text"
                       id="username"
                       name="username"
                       value="<%= editUser ? editUser.username : '' %>"
                       <%= editUser ? 'readonly' : 'required' %>
                       pattern="[a-zA-Z0-9_]{3,50}"
                       title="3-50 characters, letters, numbers, and underscores only">
                <small>Username cannot be changed after creation</small>
            </div>

            <div class="form-group">
                <label for="full_name">Full Name</label>
                <input type="text"
                       id="full_name"
                       name="full_name"
                       value="<%= editUser ? editUser.full_name : '' %>"
                       maxlength="100">
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email"
                       id="email"
                       name="email"
                       value="<%= editUser ? editUser.email : '' %>">
            </div>

            <div class="form-group">
                <label for="role">Role *</label>
                <select id="role" name="role" required>
                    <% roles.forEach(role => { %>
                        <option value="<%= role.value %>"
                                <%= editUser && editUser.role === role.value ? 'selected' : '' %>>
                            <%= role.display %>
                        </option>
                    <% }); %>
                </select>
            </div>

            <% if (!editUser) { %>
                <div class="form-group">
                    <label for="password">Password *</label>
                    <input type="password"
                           id="password"
                           name="password"
                           required
                           minlength="6">
                    <small>Minimum 6 characters</small>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm Password *</label>
                    <input type="password"
                           id="confirm_password"
                           name="confirm_password"
                           required
                           minlength="6">
                </div>
            <% } else { %>
                <div class="form-group">
                    <label for="password">New Password (leave blank to keep current)</label>
                    <input type="password"
                           id="password"
                           name="password"
                           minlength="6">
                    <small>Minimum 6 characters</small>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <input type="password"
                           id="confirm_password"
                           name="confirm_password"
                           minlength="6">
                </div>

                <% if (editUser.is_active === 0) { %>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="is_active" value="1">
                            Activate User
                        </label>
                    </div>
                <% } %>
            <% } %>

            <div class="form-actions">
                <button type="submit" class="btn">
                    <%= editUser ? 'Update User' : 'Create User' %>
                </button>
                <a href="/admin/users" class="btn" style="background: #95a5a6;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }
    .form-group input[readonly] {
        background-color: #f5f5f5;
    }
    .form-group small {
        display: block;
        margin-top: 0.25rem;
        color: #666;
        font-size: 0.875rem;
    }
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }
    .alert {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }
    .alert-error {
        background: #fee;
        color: #c00;
        border: 1px solid #fcc;
    }
</style>

<script>
document.getElementById('userForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;

    // Validate passwords match
    if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
    }

    // Prepare form data
    const formData = {
        username: document.getElementById('username').value,
        full_name: document.getElementById('full_name').value || null,
        email: document.getElementById('email').value || null,
        role: document.getElementById('role').value
    };

    // For edit mode, only include password if it's been changed
    const isEdit = <%= editUser ? 'true' : 'false' %>;

    if (password) {
        formData.password = password;
    }

    if (isEdit) {
        const isActiveCheckbox = document.querySelector('input[name="is_active"]');
        if (isActiveCheckbox) {
            formData.is_active = isActiveCheckbox.checked;
        }
    }

    try {
        const url = isEdit
            ? `/api/admin/users/<%= editUser ? editUser.id : '' %>`
            : '/api/admin/users';

        const method = isEdit ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
            window.location.href = '/admin/users?success=' +
                encodeURIComponent(isEdit ? 'User updated successfully' : 'User created successfully');
        } else {
            // Handle validation errors
            if (result.errors) {
                const errorMessages = result.errors.map(e => e.msg || e.message).join(', ');
                alert('Validation errors: ' + errorMessages);
            } else {
                alert(result.error || 'Failed to save user');
            }
        }
    } catch (error) {
        alert('Failed to save user: ' + error.message);
    }
});
</script>

<%- include('../partials/footer') %>