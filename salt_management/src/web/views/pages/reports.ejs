<%
var pageTitle = typeof title !== 'undefined' ? title : 'Reports';
var body = `
<h2>Reports Management</h2>

<div class="card" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3>Available Reports</h3>
        <button class="btn" onclick="createNewReport()">
            <i class="fas fa-plus"></i> New Report
        </button>
    </div>

    <div id="reportsList">
        <div style="text-align: center; padding: 2rem;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #3498db;"></i>
            <p>Loading reports...</p>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div id="scheduleModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; margin: 5% auto; padding: 2rem; width: 500px; border-radius: 8px;">
        <h3>Schedule Report</h3>
        <div style="margin-bottom: 1rem;">
            <label>Schedule Type:</label>
            <select id="scheduleType" onchange="updateScheduleFields()" style="width: 100%; padding: 0.5rem;">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label>Time (24-hour format):</label>
            <input type="time" id="scheduleTime" style="width: 100%; padding: 0.5rem;">
        </div>

        <div id="dayField" style="margin-bottom: 1rem; display: none;">
            <label id="dayLabel">Day:</label>
            <select id="scheduleDay" style="width: 100%; padding: 0.5rem;">
                <!-- Options populated by JavaScript -->
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label>
                <input type="checkbox" id="scheduleActive" checked> Active
            </label>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn" style="background: #95a5a6;" onclick="closeScheduleModal()">Cancel</button>
            <button class="btn" onclick="saveSchedule()">Save Schedule</button>
        </div>
    </div>
</div>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
    .report-row {
        padding: 1rem;
        border-bottom: 1px solid #ecf0f1;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .report-row:hover {
        background: #f8f9fa;
    }

    .report-info {
        flex: 1;
    }

    .report-name {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }

    .report-meta {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .report-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
        margin-right: 0.5rem;
    }

    .status-active {
        background: #d4edda;
        color: #155724;
    }

    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }

    .status-scheduled {
        background: #d1ecf1;
        color: #0c5460;
    }

    .report-actions {
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        padding: 0.25rem 0.75rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        background: #3498db;
        color: white;
    }

    .action-btn:hover {
        opacity: 0.9;
    }

    .action-btn.danger {
        background: #e74c3c;
    }

    .action-btn.success {
        background: #27ae60;
    }

    .action-btn.warning {
        background: #f39c12;
    }
</style>

<script>
let currentReportId = null;
let reports = [];

// Load reports on page load
document.addEventListener('DOMContentLoaded', function() {
    loadReports();
});

async function loadReports() {
    try {
        const response = await fetch('/api/admin/reports', {
            credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success) {
            reports = data.reports;
            renderReports(reports);
        } else {
            showError('Failed to load reports');
        }
    } catch (error) {
        console.error('Error loading reports:', error);
        showError('Failed to load reports');
    }
}

function renderReports(reports) {
    const container = document.getElementById('reportsList');

    if (reports.length === 0) {
        container.innerHTML = \`
            <div style="text-align: center; padding: 2rem; color: #6c757d;">
                <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>No reports found. Create your first report to get started!</p>
            </div>
        \`;
        return;
    }

    let html = '';
    reports.forEach(report => {
        const lastRun = report.last_run ? new Date(report.last_run).toLocaleString() : 'Never';
        const nextRun = report.next_run ? new Date(report.next_run).toLocaleString() : 'Not scheduled';
        const successRate = report.total_runs > 0
            ? Math.round((report.successful_runs / report.total_runs) * 100)
            : 0;

        html += \`
            <div class="report-row">
                <div class="report-info">
                    <div class="report-name">\${report.name}</div>
                    <div class="report-meta">
                        \${report.description || 'No description'}
                        <br>
                        <small>
                            Runs: \${report.total_runs} | Success rate: \${successRate}% | Last run: \${lastRun}
                            \${report.schedule_active ? \` | Next: \${nextRun}\` : ''}
                        </small>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span class="report-status \${report.is_active ? 'status-active' : 'status-inactive'}">
                            \${report.is_active ? 'Active' : 'Inactive'}
                        </span>
                        \${report.schedule_active ? '<span class="report-status status-scheduled">Scheduled</span>' : ''}
                    </div>
                </div>
                <div class="report-actions">
                    <button class="action-btn" onclick="editReport(\${report.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="action-btn success" onclick="runReport(\${report.id})">
                        <i class="fas fa-play"></i> Run
                    </button>
                    <button class="action-btn" onclick="viewHistory(\${report.id})">
                        <i class="fas fa-history"></i> History
                    </button>
                    <button class="action-btn warning" onclick="scheduleReport(\${report.id})">
                        <i class="fas fa-clock"></i> Schedule
                    </button>
                    <button class="action-btn danger" onclick="deleteReport(\${report.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        \`;
    });

    container.innerHTML = html;
}

function createNewReport() {
    window.location.href = '/reports/new';
}

function editReport(id) {
    window.location.href = \`/reports/\${id}/edit\`;
}

async function runReport(id) {
    if (!confirm('Run this report now?')) return;

    try {
        const response = await fetch(\`/api/admin/reports/\${id}/run\`, {
            method: 'POST',
            credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success) {
            alert('Report execution started. Check the history for results.');
        } else {
            alert('Failed to run report: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error running report:', error);
        alert('Failed to run report');
    }
}

function viewHistory(id) {
    window.location.href = \`/reports/\${id}/history\`;
}

async function deleteReport(id) {
    if (!confirm('Are you sure you want to delete this report?')) return;

    try {
        const response = await fetch(\`/api/admin/reports/\${id}\`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success) {
            loadReports();
        } else {
            alert('Failed to delete report: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting report:', error);
        alert('Failed to delete report');
    }
}

function scheduleReport(id) {
    currentReportId = id;

    // Load existing schedule if any
    fetch(\`/api/admin/reports/\${id}/schedule\`, {
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.schedule) {
            document.getElementById('scheduleType').value = data.schedule.schedule_type;
            document.getElementById('scheduleTime').value = data.schedule.schedule_time;
            document.getElementById('scheduleActive').checked = data.schedule.is_active;

            updateScheduleFields();

            if (data.schedule.schedule_day !== null) {
                document.getElementById('scheduleDay').value = data.schedule.schedule_day;
            }
        } else {
            // Set defaults
            document.getElementById('scheduleType').value = 'daily';
            document.getElementById('scheduleTime').value = '09:00';
            document.getElementById('scheduleActive').checked = true;
            updateScheduleFields();
        }
    });

    document.getElementById('scheduleModal').style.display = 'block';
}

function updateScheduleFields() {
    const type = document.getElementById('scheduleType').value;
    const dayField = document.getElementById('dayField');
    const daySelect = document.getElementById('scheduleDay');

    if (type === 'daily') {
        dayField.style.display = 'none';
    } else if (type === 'weekly') {
        dayField.style.display = 'block';
        document.getElementById('dayLabel').textContent = 'Day of Week:';

        daySelect.innerHTML = \`
            <option value="0">Sunday</option>
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
        \`;
    } else if (type === 'monthly') {
        dayField.style.display = 'block';
        document.getElementById('dayLabel').textContent = 'Day of Month:';

        let options = '';
        for (let i = 1; i <= 31; i++) {
            options += \`<option value="\${i}">\${i}</option>\`;
        }
        daySelect.innerHTML = options;
    }
}

function closeScheduleModal() {
    document.getElementById('scheduleModal').style.display = 'none';
    currentReportId = null;
}

async function saveSchedule() {
    if (!currentReportId) return;

    const schedule = {
        schedule_type: document.getElementById('scheduleType').value,
        schedule_time: document.getElementById('scheduleTime').value,
        is_active: document.getElementById('scheduleActive').checked
    };

    if (schedule.schedule_type !== 'daily') {
        schedule.schedule_day = document.getElementById('scheduleDay').value;
    }

    try {
        const response = await fetch(\`/api/admin/reports/\${currentReportId}/schedule\`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(schedule)
        });

        const data = await response.json();

        if (data.success) {
            alert('Schedule saved successfully. Next run: ' + new Date(data.nextRun).toLocaleString());
            closeScheduleModal();
            loadReports();
        } else {
            alert('Failed to save schedule: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving schedule:', error);
        alert('Failed to save schedule');
    }
}

function showError(message) {
    document.getElementById('reportsList').innerHTML = \`
        <div style="padding: 2rem; text-align: center; color: #dc3545;">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>\${message}</p>
        </div>
    \`;
}
</script>
` %>
<%- include('../layouts/main', { body: body, title: pageTitle, user: user }) %>